<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fadis Youth Chat</title>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Base Reset and Fonts */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      font-family: 'Poppins', sans-serif;
      background: #f8f9fa; color: #2d3748;
    }
    body { display: flex; flex-direction: column; }
    
    /* Chat Container */
    .chat-container {
      display: flex; flex: 1;
      overflow: hidden;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
      border-radius: 10px; margin: 10px; background: #fff;
    }
    
    /* Hamburger / Format Button Styles */
    .hamburger {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer; z-index: 10;
      color: #4a5568;
      background: transparent;
      width: 40px; height: 40px;
      border: none; outline: none;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.3s ease;
    }
    .hamburger.active { transform: rotate(90deg); }
    
    /* Sidebar on the right */
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100%;
      background: #fff;
      border-left: 1px solid #e2e8f0;
      transition: right 0.3s ease;
      z-index: 9;
      display: flex;
      flex-direction: column;
    }
    .sidebar.active {
      right: 0;
    }
    .sidebar-header {
      background: #2c5282; color: #fff;
      padding: 20px; text-align: center;
      font-size: 1.2rem; font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .search-container {
      padding: 15px; border-bottom: 1px solid #e2e8f0;
    }
    .search-input {
      width: 100%; padding: 10px 15px;
      border: 1px solid #e2e8f0; border-radius: 25px;
      font-size: 0.9rem; outline: none;
      transition: border-color 0.3s ease;
    }
    .search-input:focus {
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66,153,225,0.2);
    }
    .contact-list {
      flex: 1; overflow-y: auto;
    }
    .contact-item {
      padding: 12px 15px; border-bottom: 1px solid #f0f4f8;
      cursor: pointer; display: flex; align-items: center;
      transition: background 0.2s ease;
    }
    .contact-item:hover { background: #f8fafc; }
    .contact-item.active { background: #ebf8ff; }
    .contact-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: #2b6cb0; color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; margin-right: 12px;
      position: relative; flex-shrink: 0;
    }
    .status-dot {
      position: absolute; bottom: 0; right: 0;
      width: 10px; height: 10px; border-radius: 50%;
      background: #48bb78; border: 2px solid #fff;
    }
    .inactive-dot { background: #a0aec0; }
    .contact-name { font-size: 0.95rem; font-weight: 500; color: #2d3748; }
    .contact-last-message {
      font-size: 0.8rem; color: #718096; margin-top: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    /* Chat Window */
    .chat-window {
      flex: 1; display: flex; flex-direction: column;
      background: #f0f4f8; margin-left: 0; position: relative;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkiPjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0icmdiYSgyNDIsMjQ0LDI0NSwwLjAzKSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNwYXR0ZXJuKSIvPjwvc3ZnPg==');
    }
    .chat-header {
      background: #fff; padding: 15px 20px;
      border-bottom: 1px solid #e2e8f0; font-size: 1.1rem; font-weight: 600;
      flex-shrink: 0; display: flex; align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .chat-header-info { flex: 1; text-align: center; }
    .chat-header-actions { display: flex; gap: 15px; }
    .chat-header-action {
      color: #4a5568; cursor: pointer; transition: transform 0.2s ease;
    }
    .chat-header-action:hover { color: #2b6cb0; transform: scale(1.1); }
    .message-list {
      flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden;
    }
    .message-date-divider {
      text-align: center; margin: 15px 0; position: relative;
    }
    .message-date-divider span {
      background: #e2e8f0; padding: 5px 12px; border-radius: 20px;
      font-size: 0.75rem; color: #4a5568; font-weight: 500; position: relative; z-index: 1;
    }
    .message-date-divider:before {
      content: ""; position: absolute; top: 50%; left: 0; right: 0;
      height: 1px; background: #e2e8f0; z-index: 0;
    }
    .message {
      margin-bottom: 15px; max-width: 75%; padding: 12px 15px;
      border-radius: 12px; position: relative; clear: both;
      word-wrap: break-word; background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s ease;
    }
    .message:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .message.sent {
      background: #ebf8ff; margin-left: auto; border-bottom-right-radius: 4px;
    }
    .message.received {
      background: #fff; margin-right: auto; border-bottom-left-radius: 4px;
    }
    .message .sender-name {
      font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: #2b6cb0;
    }
    .message .message-text { 
      font-size: 0.95rem; line-height: 1.4; white-space: pre-wrap;
      overflow-wrap: break-word;
    }
    .message .message-text a {
      color: #3182ce;
      text-decoration: underline;
    }
    .message .message-text b, .message .message-text strong {
      font-weight: 600;
    }
    .message .message-text i, .message .message-text em {
      font-style: italic;
    }
    .message .message-text u {
      text-decoration: underline;
    }
    .message .message-image {
      max-width: 250px; max-height: 250px; display: block; margin-top: 8px;
      border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;
      transition: transform 0.2s ease;
    }
    .message .message-image:hover { transform: scale(1.02); }
    .message .tick-status {
      position: absolute; bottom: 6px; right: 8px;
      font-size: 0.7rem; color: #718096;
    }
    .message .tick-status.seen { color: #4299e1; }
    .reply-btn {
      position: absolute; bottom: 6px; left: 8px; font-size: 0.7rem;
      color: #4a5568; cursor: pointer; opacity: 0; transition: opacity 0.2s ease;
    }
    .message:hover .reply-btn { opacity: 1; }
    .edit-btn {
      position: absolute; bottom: 6px; right: 28px; font-size: 0.7rem;
      color: #4a5568; cursor: pointer; opacity: 0; transition: opacity 0.2s ease;
    }
    .message:hover .edit-btn { opacity: 1; }
    .reaction-panel {
      position: absolute; bottom: 45px; right: 10px;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 20px;
      padding: 5px 10px; display: none; z-index: 5;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .reaction-panel span {
      cursor: pointer; font-size: 1.2rem; margin: 0 5px;
      transition: transform 0.2s ease;
    }
    .reaction-panel span:hover { transform: scale(1.2); }
    .message-reaction {
      position: absolute; bottom: -8px; right: 10px;
      background: #fff; padding: 2px 6px; border-radius: 10px;
      font-size: 0.7rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Chat Input Area */
    .chat-input-container {
      display: flex; align-items: center;
      padding: 15px; background: #fff;
      border-top: 1px solid #e2e8f0; flex-shrink: 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    .chat-input {
      flex: 1; padding: 12px 15px;
      border: 1px solid #e2e8f0; border-radius: 25px;
      font-size: 0.95rem; margin-right: 10px; outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .chat-input:focus {
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66,153,225,0.2);
    }
    .send-button {
      background: #2b6cb0; border: none; color: #fff;
      width: 45px; height: 45px; border-radius: 50%;
      cursor: pointer; display: flex; align-items: center;
      justify-content: center; font-size: 1.2rem; margin-right: 10px;
      transition: transform 0.2s ease, background 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .send-button:hover {
      background: #2c5282; transform: scale(1.05);
    }
    .send-button:disabled {
      background: #a0aec0; cursor: not-allowed; transform: none;
    }
    
    /* Reply Info above Input */
    .reply-info {
      background: #fff; border-left: 4px solid #2b6cb0;
      padding: 10px 15px; font-size: 0.85rem; color: #4a5568;
      margin: 0; flex-shrink: 0; display: flex;
      justify-content: space-between; align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .reply-info span.reply-to-text {
      font-weight: 600; color: #2b6cb0; cursor: pointer;
    }
    .reply-cancel {
      color: #e53e3e; cursor: pointer; font-size: 1rem; margin-left: 10px;
    }
    
    /* Typing Indicator */
    .typing-indicator {
      padding: 5px 15px; font-size: 0.8rem; color: #4a5568;
      font-style: italic; display: flex; align-items: center;
    }
    .typing-dots { display: flex; margin-left: 5px; }
    .typing-dot {
      width: 6px; height: 6px; background: #4a5568;
      border-radius: 50%; margin: 0 2px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    /* Context Menu - Now on left side */
    .context-menu {
      position: fixed; background: #fff;
      border: 1px solid #e2e8f0; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100; display: none;
    }
    .context-menu-item {
      padding: 10px 15px; cursor: pointer;
      font-size: 0.9rem; color: #2d3748;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .context-menu-item:hover {
      background: #ebf8ff; color: #2b6cb0;
    }
    .context-menu-item i {
      margin-right: 8px; width: 18px; text-align: center;
    }
    
    /* Image Preview Modal */
    .image-modal {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .image-modal.active {
      opacity: 1; pointer-events: all;
    }
    .image-modal-content {
      max-width: 90%; max-height: 90%;
    }
    .image-modal-close {
      position: absolute; top: 20px; right: 20px;
      color: #fff; font-size: 2rem; cursor: pointer;
    }
    
    /* Formatting Toolbar for Chat Input */
    .format-toolbar {
      position: absolute;
      bottom: 65px;
      right: 15px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
      z-index: 15;
    }
    .format-toolbar button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      font-size: 1rem;
      color: #4a5568;
      transition: color 0.2s ease;
    }
    .format-toolbar button:hover {
      color: #2b6cb0;
    }
    .format-btn-container {
      position: relative;
    }
    /* Three-dot button for formatting */
    .format-toggle {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #4a5568;
      cursor: pointer;
      margin-right: 10px;
    }
    
    /* Login Prompt */
    .login-prompt {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      text-align: center;
    }
    .login-prompt button {
      background: #2b6cb0;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.2s ease;
    }
    .login-prompt button:hover {
      background: #2c5282;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .chat-container {
        flex-direction: column; margin: 0; border-radius: 0;
      }
      .sidebar { width: 100%; height: 40vh; right: -100%; }
      .sidebar.active { right: 0; }
      .chat-window { height: 60vh; }
      .message { max-width: 85%; }
    }
    @media (max-width: 480px) {
      .chat-header { padding: 10px; }
      .chat-header-action { margin-left: 10px; }
      .message-list { padding: 10px; }
      .chat-input-container { padding: 8px 10px; }
      .message .message-image { max-width: 180px; }
    }
  </style>
</head>
<body>
  <!-- Main container -->
  <div class="chat-container">
    <!-- Hamburger / Format Toggle Button (now on right) -->
    <button class="hamburger" id="hamburgerBtn" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar (right side) -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">Fadis Youth Chat</div>
      <div class="search-container">
        <input type="text" class="search-input" placeholder="Search contacts..." id="searchInput" oninput="searchContacts()">
      </div>
      <div class="contact-list" id="contactList">
        <!-- Built-in groups first -->
        <div class="contact-item" onclick="openGroup('FadisYouth','Fadis Youth Group')">
          <div class="contact-avatar" style="background:#2b6cb0;">F</div>
          <div>
            <div class="contact-name">Fadis Youth Group</div>
            <div class="contact-last-message" style="font-size:0.7rem;">Welcome to our community</div>
          </div>
        </div>
        <div class="contact-item" onclick="openGroup('QuranGroup','Quran Group')">
          <div class="contact-avatar" style="background:#2b6cb0;">Q</div>
          <div>
            <div class="contact-name">Quran Group</div>
            <div class="contact-last-message" style="font-size:0.7rem;">Discuss Quranic teachings</div>
          </div>
        </div>
        <div class="contact-item" onclick="openGroup('HalalJokes','Halal Jokes')">
          <div class="contact-avatar" style="background:#2b6cb0;">H</div>
          <div>
            <div class="contact-name">Halal Jokes</div>
            <div class="contact-last-message" style="font-size:0.7rem;">Share clean humor</div>
          </div>
        </div>
        <div class="contact-item" onclick="openGroup('IslamicChat','Islamic Chat')">
          <div class="contact-avatar" style="background:#2b6cb0;">I</div>
          <div>
            <div class="contact-name">Islamic Chat</div>
            <div class="contact-last-message" style="font-size:0.7rem;">General Islamic discussions</div>
          </div>
        </div>
        <!-- Firestore users appended here -->
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <div class="chat-header-info" id="chatHeader">Select a Chat</div>
        <div class="chat-header-actions" id="chatHeaderActions" style="display:none;">
          <i class="fas fa-phone-alt chat-header-action" title="Voice Call"></i>
          <i class="fas fa-video chat-header-action" title="Video Call"></i>
          <i class="fas fa-info-circle chat-header-action" title="Chat Info"></i>
        </div>
      </div>
      <div id="replyInfo" class="reply-info" style="display:none;"></div>
      <div class="message-list" id="messageList">
        <!-- Messages will be loaded here -->
        <div id="loginPrompt" class="login-prompt" style="display:none;">
          <h3>Please log in to view and send messages</h3>
          <p>Connect with the Fadis Youth community by signing in</p>
          <button onclick="redirectToLogin()">Log In / Register</button>
        </div>
      </div>
      <div class="typing-indicator" id="typingIndicator" style="display:none;">
        <span id="typingText">Typing</span>
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
      <div class="chat-input-container" id="chatInputContainer" style="display:none;">
        <!-- Hidden file input -->
        <input type="file" id="fileInput" style="display:none;" accept="image/*,application/pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />
        <!-- Formatting Toggle Button -->
        <div class="format-btn-container">
          <button class="format-toggle" id="formatToggleBtn"><i class="fas fa-ellipsis-h"></i></button>
          <div class="format-toolbar" id="formatToolbar">
            <button onclick="applyFormat('bold')"><i class="fas fa-bold"></i></button>
            <button onclick="applyFormat('italic')"><i class="fas fa-italic"></i></button>
            <button onclick="applyFormat('underline')"><i class="fas fa-underline"></i></button>
            <button onclick="applyFormat('spoiler')"><i class="fas fa-eye-slash"></i></button>
            <button onclick="applyFormat('link')"><i class="fas fa-link"></i></button>
            <button onclick="document.getElementById('fileInput').click()"><i class="fas fa-paperclip"></i></button>
          </div>
        </div>
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." />
        <button class="send-button" id="sendButton" disabled>
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Context Menu (now on left side) -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="replyFromContextMenu()"><i class="fas fa-reply"></i> Reply</div>
    <div class="context-menu-item" onclick="editFromContextMenu()"><i class="fas fa-edit"></i> Edit</div>
    <div class="context-menu-item" onclick="deleteFromContextMenu()"><i class="fas fa-trash"></i> Delete</div>
    <div class="context-menu-item" onclick="copyFromContextMenu()"><i class="fas fa-copy"></i> Copy</div>
  </div>

  <!-- Image Preview Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
    <span class="image-modal-close">&times;</span>
    <img class="image-modal-content" id="modalImage">
  </div>

  <script>
    // ---------------- Firebase Config & Init ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyAFgxSMtktsqJjcJOMnkTB8yZF6T492gpA",
      authDomain: "fadis-youth.firebaseapp.com",
      databaseURL: "https://fadis-youth-default-rtdb.firebaseio.com",
      projectId: "fadis-youth",
      storageBucket: "fadis-youth.firebasestorage.app",
      messagingSenderId: "1067077305340",
      appId: "1:1067077305340:web:3ca9c71202a8020c6ba879",
      measurementId: "G-Z02SPW9ZKW"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ---------------- Auth & Online Status ----------------
    let currentUser = null;
    let authResolved = false;
    let authTimeout = null;
    
    // Initialize auth state listener
    function initializeAuth() {
      authResolved = false;
      
      // Set timeout for auth resolution
      authTimeout = setTimeout(() => {
        if (!authResolved) {
          showLoginPrompt("Authentication check timed out. Please log in.");
        }
      }, 10000);
      
      // Auth state listener
      auth.onAuthStateChanged((user) => {
        clearTimeout(authTimeout);
        authResolved = true;
        
        if (user) {
          // User is signed in
          currentUser = user;
          updateUserOnlineStatus(true);
          loadContacts();
          hideLoginPrompt();
          
          // Set up beforeunload handler to mark user as offline
          window.addEventListener('beforeunload', () => {
            updateUserOnlineStatus(false);
          });
        } else {
          // No user is signed in
          currentUser = null;
          showLoginPrompt("Please log in to access the chat");
        }
      }, (error) => {
        console.error("Auth state error:", error);
        showLoginPrompt("Authentication error. Please log in again.");
      });
    }
    
    function updateUserOnlineStatus(online) {
      if (!currentUser) return;
      
      const statusUpdate = {
        online: online,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection("users").doc(currentUser.uid).update(statusUpdate)
        .catch(error => {
          console.error("Error updating user status:", error);
        });
    }
    
    function showLoginPrompt(message) {
      const loginPrompt = document.getElementById("loginPrompt");
      if (loginPrompt) {
        loginPrompt.style.display = "flex";
        if (message) {
          loginPrompt.querySelector("h3").textContent = message;
        }
      }
      document.getElementById("chatInputContainer").style.display = "none";
    }
    
    function hideLoginPrompt() {
      const loginPrompt = document.getElementById("loginPrompt");
      if (loginPrompt) {
        loginPrompt.style.display = "none";
      }
    }
    
    function redirectToLogin() {
      window.location.href = "login.html";
    }

    // ---------------- Global Variables ----------------
    let currentChatId = null;
    let currentChatIsGroup = false;
    let messageUnsubscribe = null;
    let replyTarget = null;
    let typingTimeout = null;
    let contextMenuMessageId = null;
    let pendingUploadUrl = null;
    let pendingUploadIsImage = false;
    let pendingMessages = {}; // Track pending messages for optimistic UI

    // ---------------- DOM Event Listeners ----------------
    document.addEventListener('DOMContentLoaded', () => {
      initializeAuth();
      
      // Initialize UI event listeners
      document.getElementById('hamburgerBtn').addEventListener('click', toggleSidebar);
      document.getElementById('searchInput').addEventListener('input', searchContacts);
      
      // Chat input events
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.getElementById('sendButton');
      
      chatInput.addEventListener('input', handleTyping);
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendButton.disabled) sendMessage();
        }
      });
      sendButton.addEventListener('click', sendMessage);
      
      // Format toolbar toggle
      const formatToggle = document.getElementById('formatToggleBtn');
      formatToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFormatToolbar(e);
      });
      
      // File input handler
      document.getElementById('fileInput').addEventListener('change', (e) => {
        uploadFile(e.target.files);
        e.target.value = ''; // Reset input to allow same file to be selected again
      });
      
      // Close format toolbar when clicking elsewhere
      document.addEventListener('click', (e) => {
        const toolbar = document.getElementById('formatToolbar');
        if (toolbar.style.display === 'block' && 
            !toolbar.contains(e.target) && 
            e.target !== formatToggle) {
          toolbar.style.display = 'none';
        }
      });
    });

    // ---------------- Sidebar & Search ----------------
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("active");
      
      // Animate hamburger icon
      const btnIcon = document.querySelector("#hamburgerBtn i");
      btnIcon.classList.toggle("fa-bars");
      btnIcon.classList.toggle("fa-times");
    }
    
    function searchContacts() {
      const term = document.getElementById("searchInput").value.toLowerCase();
      document.querySelectorAll(".contact-item").forEach(item => {
        const name = item.querySelector(".contact-name").textContent.toLowerCase();
        item.style.display = name.includes(term) ? "flex" : "none";
      });
    }
    
    function loadContacts() {
      const contactList = document.getElementById("contactList");
      const builtInCount = 4; // Number of built-in groups
      
      // Remove all dynamic contacts (keep built-in groups)
      while (contactList.children.length > builtInCount) {
        contactList.removeChild(contactList.lastChild);
      }
      
      if (!currentUser) return;
      
      db.collection("users")
        .orderBy("displayName")
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            if (doc.id === currentUser.uid) return; // Skip current user
            
            const userData = doc.data();
            const displayName = userData.displayName || "Unknown";
            const lastMessage = userData.lastMessage || "No messages yet";
            const isOnline = userData.online || false;
            
            const contactItem = document.createElement("div");
            contactItem.className = "contact-item";
            contactItem.onclick = (e) => openDirectChat(doc.id, displayName, e);
            
            contactItem.innerHTML = `
              <div class="contact-avatar">
                ${displayName.charAt(0).toUpperCase()}
                <div class="status-dot ${isOnline ? '' : 'inactive-dot'}"></div>
              </div>
              <div>
                <div class="contact-name">${displayName}</div>
                <div class="contact-last-message">${lastMessage}</div>
              </div>
            `;
            
            contactList.appendChild(contactItem);
          });
        })
        .catch(error => {
          console.error("Error loading contacts:", error);
        });
    }

    // ---------------- Chat Management ----------------
    function openDirectChat(otherUserId, displayName, event) {
      if (!currentUser) {
        showLoginPrompt("Please log in to start chatting");
        return;
      }
      
      // Highlight selected contact
      document.querySelectorAll(".contact-item").forEach(item => {
        item.classList.remove("active");
      });
      event.currentTarget.classList.add("active");
      
      // Generate chat ID (sorted user IDs joined with underscore)
      const chatId = [currentUser.uid, otherUserId].sort().join("_");
      currentChatId = chatId;
      currentChatIsGroup = false;
      
      // Update UI
      document.getElementById("chatHeader").textContent = displayName;
      document.getElementById("chatHeaderActions").style.display = "flex";
      document.getElementById("chatInputContainer").style.display = "flex";
      document.getElementById("messageList").innerHTML = "";
      document.getElementById("replyInfo").style.display = "none";
      replyTarget = null;
      
      // Close sidebar on mobile
      document.getElementById("sidebar").classList.remove("active");
      
      // Create or verify chat document
      const chatDoc = db.collection("chats").doc(chatId);
      
      chatDoc.get().then(docSnap => {
        if (!docSnap.exists) {
          // Create new chat document
          chatDoc.set({
            participants: [currentUser.uid, otherUserId],
            isGroup: false,
            chatName: displayName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        // Subscribe to messages
        subscribeToMessages(chatId);
      }).catch(error => {
        console.error("Error opening chat:", error);
      });
    }
    
    async function openGroup(groupId, groupName) {
      // Highlight selected group
      document.querySelectorAll(".contact-item").forEach(item => {
        item.classList.remove("active");
      });
      event.currentTarget.classList.add("active");
      
      // Close sidebar on mobile
      document.getElementById("sidebar").classList.remove("active");
      
      // Clear message list and reply info
      document.getElementById("messageList").innerHTML = "";
      document.getElementById("replyInfo").style.display = "none";
      replyTarget = null;
      
      currentChatId = groupId;
      currentChatIsGroup = true;
      
      if (!currentUser) {
        // Not logged in - show group info but no input
        document.getElementById("chatHeader").textContent = `${groupName} (Login required)`;
        document.getElementById("chatHeaderActions").style.display = "none";
        document.getElementById("chatInputContainer").style.display = "none";
        showLoginPrompt("Log in to participate in this group");
        subscribeToMessages(groupId);
        return;
      }
      
      const groupDoc = db.collection("chats").doc(groupId);
      
      try {
        let groupSnap = await groupDoc.get();
        
        if (!groupSnap.exists) {
          // Create new group
          await groupDoc.set({
            participants: [],
            isGroup: true,
            chatName: groupName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          groupSnap = await groupDoc.get();
        }
        
        const groupData = groupSnap.data() || {};
        const participants = groupData.participants || [];
        
        // Check if user is a member
        if (!participants.includes(currentUser.uid)) {
          const join = confirm(`Join ${groupName}?`);
          if (join) {
            await groupDoc.update({
              participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
          }
        }
        
        // Update UI with group info
        document.getElementById("chatHeader").innerHTML = `
          ${groupName}<br>
          <small style="font-size:0.7rem;color:#718096;">${participants.length} members</small>
        `;
        
        document.getElementById("chatHeaderActions").style.display = "flex";
        document.getElementById("chatInputContainer").style.display = "flex";
        
        // Subscribe to messages
        subscribeToMessages(groupId);
        
      } catch (error) {
        console.error("Error opening group:", error);
        alert("Could not open group. Please try again.");
      }
    }
    
    function subscribeToMessages(chatId) {
      // Unsubscribe from previous listener if exists
      if (messageUnsubscribe) {
        messageUnsubscribe();
      }
      
      // Clear any typing timeout
      if (typingTimeout) {
        clearTimeout(typingTimeout);
        document.getElementById("typingIndicator").style.display = "none";
      }
      
      const messageList = document.getElementById("messageList");
      messageList.innerHTML = "";
      
      // Subscribe to messages
      messageUnsubscribe = db.collection("chats")
        .doc(chatId)
        .collection("messages")
        .orderBy("timestamp")
        .onSnapshot({
          includeMetadataChanges: true
        }, (snapshot) => {
          // Skip if this is metadata-only change
          if (snapshot.metadata.hasPendingWrites) return;
          
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              // Check if this is a pending message we've already shown
              if (pendingMessages[change.doc.id]) {
                // Update the pending message with the actual Firestore data
                updatePendingMessage(change.doc);
                delete pendingMessages[change.doc.id];
              } else {
                addMessageToUI(change.doc);
              }
            } else if (change.type === "modified") {
              updateMessageInUI(change.doc);
            } else if (change.type === "removed") {
              removeMessageFromUI(change.doc.id);
            }
          });
          
          // Scroll to bottom
          messageList.scrollTop = messageList.scrollHeight;
        }, (error) => {
          console.error("Error subscribing to messages:", error);
        });
    }
    
    function addMessageToUI(doc) {
      const message = doc.data();
      const messageList = document.getElementById("messageList");
      
      // Create message element
      const msgDiv = document.createElement("div");
      msgDiv.setAttribute("data-doc-id", doc.id);
      
      const isSentByMe = currentUser && (message.senderId === currentUser.uid);
      msgDiv.className = `message ${isSentByMe ? "sent" : "received"}`;
      
      // Build message HTML
      let replyHtml = "";
      if (message.replyTo) {
        replyHtml = `
          <div class="reply-info" onclick="scrollToMessage('${message.replyTo.msgId}')">
            <span class="reply-to-text">${message.replyTo.senderName}:</span> 
            ${truncateText(message.replyTo.msgText, 50)}
          </div>
        `;
      }
      
      let mediaHtml = "";
      if (message.imageUrl) {
        mediaHtml = `<img class="message-image" src="${message.imageUrl}" onclick="openImageModal('${message.imageUrl}')" />`;
      } else if (message.fileUrl) {
        mediaHtml = `<a href="${message.fileUrl}" class="file-download" target="_blank">View File</a>`;
      }
      
      // Format message text with HTML tags
      let formattedText = message.text || "";
      formattedText = formatMessageText(formattedText);
      
      msgDiv.innerHTML = `
        <div class="sender-name">${message.senderName || "Guest"}</div>
        ${replyHtml}
        <div class="message-text">${formattedText}</div>
        ${mediaHtml}
        ${isSentByMe ? `<div class="tick-status ${message.seen ? "seen" : ""}">${message.seen ? "✔✔" : "✔"}</div>` : ""}
        ${!isSentByMe ? `<div class="reply-btn" onclick="replyToMessage('${doc.id}', '${message.senderName}', '${escapeHtml(message.text || "")}')"><i class="fas fa-reply"></i></div>` : ""}
        ${isSentByMe ? `<div class="edit-btn" onclick="editMessage('${doc.id}', '${escapeHtml(message.text || "")}')"><i class="fas fa-edit"></i></div>` : ""}
      `;
      
      // Add context menu for right-click
      msgDiv.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showContextMenu(e, doc.id, message);
      });
      
      messageList.appendChild(msgDiv);
    }
    
    function updatePendingMessage(doc) {
      const message = doc.data();
      const msgElement = document.querySelector(`[data-temp-id="${doc.id}"]`);
      
      if (msgElement) {
        // Update the temporary ID to the real Firestore ID
        msgElement.setAttribute("data-doc-id", doc.id);
        msgElement.removeAttribute("data-temp-id");
        
        // Update seen status if this is our message
        if (currentUser && message.senderId === currentUser.uid) {
          const tickStatus = msgElement.querySelector(".tick-status");
          if (tickStatus) {
            tickStatus.className = `tick-status ${message.seen ? "seen" : ""}`;
            tickStatus.innerHTML = message.seen ? "✔✔" : "✔";
          }
        }
      }
    }
    
    function updateMessageInUI(doc) {
      const message = doc.data();
      const msgElement = document.querySelector(`[data-doc-id="${doc.id}"]`);
      
      if (msgElement) {
        // Update seen status if this is our message
        if (currentUser && message.senderId === currentUser.uid) {
          const tickStatus = msgElement.querySelector(".tick-status");
          if (tickStatus) {
            tickStatus.className = `tick-status ${message.seen ? "seen" : ""}`;
            tickStatus.innerHTML = message.seen ? "✔✔" : "✔";
          }
        }
        
        // Update message text if edited
        if (message.text) {
          const textElement = msgElement.querySelector(".message-text");
          if (textElement) {
            textElement.innerHTML = formatMessageText(message.text);
          }
        }
      }
    }
    
    function removeMessageFromUI(messageId) {
      const msgElement = document.querySelector(`[data-doc-id="${messageId}"]`);
      if (msgElement) {
        msgElement.remove();
      }
    }
    
    function formatMessageText(text) {
      // Convert HTML tags to formatted text
      let formatted = text
        .replace(/<b>(.*?)<\/b>/g, '<strong>$1</strong>')
        .replace(/<i>(.*?)<\/i>/g, '<em>$1</em>')
        .replace(/<u>(.*?)<\/u>/g, '<u>$1</u>')
        .replace(/<a href="(.*?)".*?>(.*?)<\/a>/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$2</a>')
        .replace(/<span style='background-color:#000;color:#000;'>(.*?)<\/span>/g, 
                 '<span class="spoiler" onclick="revealSpoiler(this)">$1</span>');
      
      // Convert newlines to <br>
      formatted = formatted.replace(/\n/g, '<br>');
      
      return formatted;
    }
    
    function revealSpoiler(element) {
      element.style.backgroundColor = 'transparent';
      element.style.color = 'inherit';
    }
    
    function truncateText(text, maxLength) {
      if (!text) return "";
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + "...";
    }
    
    function escapeHtml(unsafe) {
      if (!unsafe) return "";
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ---------------- Message Actions ----------------
    function scrollToMessage(msgId) {
      const msgEl = document.querySelector(`[data-doc-id="${msgId}"]`);
      if (msgEl) {
        msgEl.scrollIntoView({ behavior: "smooth", block: "center" });
        
        // Highlight the message temporarily
        msgEl.style.transition = "background 0.5s ease";
        msgEl.style.backgroundColor = "#fff3cd";
        
        setTimeout(() => {
          msgEl.style.backgroundColor = "";
        }, 2000);
      }
    }
    
    function replyToMessage(msgId, senderName, messageText) {
      replyTarget = {
        msgId: msgId,
        senderName: senderName,
        msgText: messageText
      };
      
      const replyInfo = document.getElementById("replyInfo");
      replyInfo.innerHTML = `
        <span class="reply-to-text" onclick="scrollToMessage('${msgId}')">
          Replying to ${senderName}: ${truncateText(messageText, 50)}
        </span>
        <span class="reply-cancel" onclick="clearReply()">×</span>
      `;
      replyInfo.style.display = "flex";
      
      // Focus the input
      document.getElementById("chatInput").focus();
    }
    
    function editMessage(msgId, currentText) {
      if (!currentUser) return;
      
      const newText = prompt("Edit your message:", currentText);
      if (newText !== null && newText !== currentText) {
        db.collection("chats").doc(currentChatId)
          .collection("messages").doc(msgId)
          .update({ 
            text: newText,
            edited: true 
          })
          .catch(error => {
            console.error("Error editing message:", error);
            alert("Could not edit message. Please try again.");
          });
      }
    }
    
    function clearReply() {
      replyTarget = null;
      document.getElementById("replyInfo").style.display = "none";
    }

    // ---------------- Context Menu Functions (now on left side) ----------------
    function showContextMenu(e, msgId, message) {
      const menu = document.getElementById("contextMenu");
      menu.style.top = `${e.pageY}px`;
      menu.style.left = `${e.pageX}px`;
      menu.style.display = "block";
      
      contextMenuMessageId = msgId;
      window.currentContextMessage = message;
      
      // Hide menu when clicking elsewhere
      const hideMenu = () => {
        menu.style.display = "none";
        document.removeEventListener("click", hideMenu);
      };
      
      document.addEventListener("click", hideMenu);
    }
    
    function replyFromContextMenu() {
      if (window.currentContextMessage) {
        replyToMessage(
          contextMenuMessageId,
          window.currentContextMessage.senderName,
          window.currentContextMessage.text || ""
        );
      }
    }
    
    function editFromContextMenu() {
      if (!currentUser) {
        showLoginPrompt("Please log in to edit messages");
        return;
      }
      
      if (window.currentContextMessage && 
          window.currentContextMessage.senderId === currentUser.uid) {
        editMessage(
          contextMenuMessageId,
          window.currentContextMessage.text || ""
        );
      } else {
        alert("You can only edit your own messages.");
      }
    }
    
    function deleteFromContextMenu() {
      if (!currentUser) {
        showLoginPrompt("Please log in to delete messages");
        return;
      }
      
      if (window.currentContextMessage && 
          window.currentContextMessage.senderId === currentUser.uid) {
        if (confirm("Delete this message?")) {
          db.collection("chats").doc(currentChatId)
            .collection("messages").doc(contextMenuMessageId)
            .delete()
            .catch(error => {
              console.error("Error deleting message:", error);
              alert("Could not delete message. Please try again.");
            });
        }
      } else {
        alert("You can only delete your own messages.");
      }
    }
    
    function copyFromContextMenu() {
      if (window.currentContextMessage && window.currentContextMessage.text) {
        navigator.clipboard.writeText(window.currentContextMessage.text)
          .then(() => {
            // Show brief notification that text was copied
            const notification = document.createElement("div");
            notification.textContent = "Copied to clipboard";
            notification.style.position = "fixed";
            notification.style.bottom = "20px";
            notification.style.left = "50%";
            notification.style.transform = "translateX(-50%)";
            notification.style.backgroundColor = "#2b6cb0";
            notification.style.color = "white";
            notification.style.padding = "8px 16px";
            notification.style.borderRadius = "4px";
            notification.style.zIndex = "1000";
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 2000);
          })
          .catch(err => {
            console.error("Copy error:", err);
            alert("Could not copy message. Please try again.");
          });
      }
    }

    // ---------------- Message Formatting ----------------
    function toggleFormatToolbar(e) {
      e.stopPropagation();
      const toolbar = document.getElementById("formatToolbar");
      toolbar.style.display = toolbar.style.display === "block" ? "none" : "block";
      
      // Close toolbar when clicking elsewhere
      if (toolbar.style.display === "block") {
        const closeToolbar = (event) => {
          if (!toolbar.contains(event.target) && event.target !== document.getElementById("formatToggleBtn")) {
            toolbar.style.display = "none";
            document.removeEventListener("click", closeToolbar);
          }
        };
        
        document.addEventListener("click", closeToolbar);
      }
    }
    
    function applyFormat(formatType) {
      const input = document.getElementById("chatInput");
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const selectedText = input.value.substring(start, end);
      
      let formattedText = selectedText;
      
      switch (formatType) {
        case "bold":
          formattedText = `<b>${selectedText}</b>`;
          break;
        case "italic":
          formattedText = `<i>${selectedText}</i>`;
          break;
        case "underline":
          formattedText = `<u>${selectedText}</u>`;
          break;
        case "spoiler":
          formattedText = `<span style='background-color:#000;color:#000;'>${selectedText}</span>`;
          break;
        case "link":
          const url = prompt("Enter URL:", "https://");
          if (url) {
            const displayText = selectedText || prompt("Enter display text:", "Link");
            if (displayText) {
              formattedText = `<a href="${url}">${displayText}</a>`;
            }
          } else {
            return; // User cancelled
          }
          break;
      }
      
      // Replace selection with formatted text
      input.setRangeText(formattedText, start, end, "end");
      
      // Focus back on input and set cursor position
      input.focus();
      input.selectionStart = start + formattedText.length;
      input.selectionEnd = start + formattedText.length;
      
      // Trigger input event to update send button state
      const event = new Event("input", { bubbles: true });
      input.dispatchEvent(event);
      
      // Hide toolbar
      document.getElementById("formatToolbar").style.display = "none";
    }

    // ---------------- Message Sending (Optimistic UI) ----------------
    function handleTyping() {
      const input = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      
      sendButton.disabled = input.value.trim() === "" && !pendingUploadUrl;
      
      // Show typing indicator (only in direct chats)
      if (!currentChatIsGroup && currentChatId && currentUser) {
        document.getElementById("typingIndicator").style.display = "flex";
        
        if (typingTimeout) {
          clearTimeout(typingTimeout);
        }
        
        typingTimeout = setTimeout(() => {
          document.getElementById("typingIndicator").style.display = "none";
        }, 1500);
      }
    }
    
    async function sendMessage() {
      if (!currentUser) {
        showLoginPrompt("Please log in to send messages");
        return;
      }
      
      if (!currentChatId) {
        alert("No chat selected");
        return;
      }
      
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      
      // Don't send empty messages unless there's a file
      if (text === "" && !pendingUploadUrl) {
        return;
      }
      
      // Create temporary message ID for optimistic UI
      const tempMessageId = `temp-${Date.now()}`;
      
      // Create message object
      const message = {
        senderId: currentUser.uid,
        senderName: currentUser.displayName || "Anonymous",
        text: text,
        seen: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add reply info if exists
      if (replyTarget) {
        message.replyTo = {
          msgId: replyTarget.msgId,
          senderName: replyTarget.senderName,
          msgText: replyTarget.msgText
        };
      }
      
      // Add media if exists
      if (pendingUploadUrl) {
        if (pendingUploadIsImage) {
          message.imageUrl = pendingUploadUrl;
        } else {
          message.fileUrl = pendingUploadUrl;
        }
      }
      
      // Optimistic UI - show message immediately
      showOptimisticMessage(tempMessageId, message);
      
      try {
        // Add message to Firestore
        const docRef = await db.collection("chats")
          .doc(currentChatId)
          .collection("messages")
          .add(message);
        
        // Track this pending message
        pendingMessages[docRef.id] = tempMessageId;
        
        // Clear input and reset state
        input.value = "";
        clearReply();
        pendingUploadUrl = null;
        pendingUploadIsImage = false;
        document.getElementById("sendButton").disabled = true;
        
        // Update last message in chat document
        await db.collection("chats")
          .doc(currentChatId)
          .update({
            lastMessage: text || (pendingUploadIsImage ? "Image" : "File"),
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
          });
        
        // Update last message in user's document if direct chat
        if (!currentChatIsGroup) {
          const otherUserId = currentChatId.replace(currentUser.uid, "").replace("_", "");
          await db.collection("users")
            .doc(otherUserId)
            .update({
              lastMessage: text || (pendingUploadIsImage ? "Image" : "File")
            });
        }
        
      } catch (error) {
        console.error("Error sending message:", error);
        
        // Remove the optimistic message if sending failed
        removeMessageFromUI(tempMessageId);
        
        alert("Could not send message. Please try again.");
      }
    }
    
    function showOptimisticMessage(tempId, message) {
      const messageList = document.getElementById("messageList");
      
      // Create message element
      const msgDiv = document.createElement("div");
      msgDiv.setAttribute("data-temp-id", tempId);
      msgDiv.className = "message sent";
      
      // Build message HTML
      let replyHtml = "";
      if (message.replyTo) {
        replyHtml = `
          <div class="reply-info" onclick="scrollToMessage('${message.replyTo.msgId}')">
            <span class="reply-to-text">${message.replyTo.senderName}:</span> 
            ${truncateText(message.replyTo.msgText, 50)}
          </div>
        `;
      }
      
      let mediaHtml = "";
      if (message.imageUrl) {
        mediaHtml = `<img class="message-image" src="${message.imageUrl}" onclick="openImageModal('${message.imageUrl}')" />`;
      } else if (message.fileUrl) {
        mediaHtml = `<a href="${message.fileUrl}" class="file-download" target="_blank">View File</a>`;
      }
      
      // Format message text with HTML tags
      let formattedText = message.text || "";
      formattedText = formatMessageText(formattedText);
      
      msgDiv.innerHTML = `
        <div class="sender-name">${message.senderName || "Anonymous"}</div>
        ${replyHtml}
        <div class="message-text">${formattedText}</div>
        ${mediaHtml}
        <div class="tick-status"><i class="fas fa-circle-notch fa-spin"></i></div>
        <div class="edit-btn" onclick="editMessage('${tempId}', '${escapeHtml(message.text || "")}')"><i class="fas fa-edit"></i></div>
      `;
      
      messageList.appendChild(msgDiv);
      messageList.scrollTop = messageList.scrollHeight;
    }

    // ---------------- File Upload (now in format toolbar) ----------------
    function uploadFile(files) {
      if (!currentUser) {
        showLoginPrompt("Please log in to upload files");
        return;
      }
      
      if (!files || files.length === 0) return;
      const file = files[0];
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert("File size too large. Maximum 5MB allowed.");
        return;
      }
      
      // Show upload indicator in the format toolbar
      const formatToolbar = document.getElementById("formatToolbar");
      const fileUploadBtn = formatToolbar.querySelector("button:last-child i");
      fileUploadBtn.classList.remove("fa-paperclip");
      fileUploadBtn.classList.add("fa-spinner", "fa-spin");
      
      // Upload file to Firebase Storage
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`chat_uploads/${currentUser.uid}/${Date.now()}_${file.name}`);
      
      fileRef.put(file)
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          // Set pending upload
          pendingUploadUrl = url;
          pendingUploadIsImage = file.type.startsWith("image/");
          
          // Update UI
          fileUploadBtn.classList.remove("fa-spinner", "fa-spin");
          fileUploadBtn.classList.add("fa-check");
          
          // Enable send button if there's content
          const sendButton = document.getElementById("sendButton");
          sendButton.disabled = document.getElementById("chatInput").value.trim() === "" && !pendingUploadUrl;
          
          // Show preview for images
          if (pendingUploadIsImage) {
            const input = document.getElementById("chatInput");
            if (input.value.trim() === "") {
              input.value = "[Image attached]";
              input.dispatchEvent(new Event("input"));
            }
          }
          
          // Reset icon after delay
          setTimeout(() => {
            fileUploadBtn.classList.remove("fa-check");
            fileUploadBtn.classList.add("fa-paperclip");
            formatToolbar.style.display = "none";
          }, 2000);
        })
        .catch(error => {
          console.error("Upload error:", error);
          fileUploadBtn.classList.remove("fa-spinner", "fa-spin");
          fileUploadBtn.classList.add("fa-paperclip");
          alert("File upload failed. Please try again.");
        });
    }

    // ---------------- Image Preview Modal ----------------
    function openImageModal(url) {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      
      img.onload = () => {
        modal.classList.add("active");
      };
      
      img.src = url;
    }
    
    function closeImageModal(e) {
      if (e) e.stopPropagation();
      document.getElementById("imageModal").classList.remove("active");
    }
  </script>
</body>
</html>
