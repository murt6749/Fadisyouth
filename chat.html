<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fadis Youth Chat</title>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />
  <style>
    /* Reset and base styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      color: #333;
    }
    body {
      display: flex;
      flex-direction: column;
    }

    /* Main container fills full height */
    .chat-container {
      display: flex;
      flex: 1; /* so it fills remaining vertical space */
      overflow: hidden;
      position: relative;
    }

    /* Hamburger menu */
    .hamburger {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
    }

    /* Sidebar (hidden by default) */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100%;
      background: #fff;
      border-right: 1px solid #ddd;
      transition: left 0.3s ease;
      z-index: 9;
      display: flex;
      flex-direction: column;
    }
    .sidebar.active {
      left: 0;
    }
    .sidebar-header {
      background: #0088cc;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .contact-list {
      flex: 1;
      overflow-y: auto;
    }
    .contact-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background 0.2s ease;
    }
    .contact-item:hover {
      background: #f7f7f7;
    }
    .contact-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #0088cc;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
      position: relative;
    }
    /* Active status indicator */
    .status-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4caf50;
      border: 2px solid #fff;
    }
    .inactive-dot {
      background: #aaa;
    }
    .contact-name {
      font-size: 1rem;
    }

    /* Chat Window */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
      margin-left: 0;
      position: relative;
    }
    .chat-header {
      background: #ededed;
      padding: 15px;
      border-bottom: 1px solid #ccc;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      flex-shrink: 0;
    }
    .message-list {
      flex: 1; /* fill available space */
      padding: 15px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    .message {
      margin-bottom: 15px;
      max-width: 70%;
      padding: 10px;
      border-radius: 8px;
      position: relative;
      clear: both;
      word-wrap: break-word;
      background: #fff;
    }
    .message.sent {
      background: #dcf8c6;
      margin-left: auto;
    }
    .message.received {
      background: #fff;
      margin-right: auto;
    }
    .message .sender-name {
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .message .message-text {
      font-size: 1rem;
      white-space: pre-wrap;
    }
    /* Show image in message if imageUrl is present */
    .message .message-image {
      max-width: 200px;
      max-height: 200px;
      display: block;
      margin-top: 5px;
      border-radius: 6px;
    }
    /* Tick status for sent messages */
    .message .tick-status {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 0.8rem;
      color: #999;
    }
    /* Small reply button */
    .reply-btn {
      position: absolute;
      bottom: 4px;
      left: 6px;
      font-size: 0.8rem;
      color: #0088cc;
      cursor: pointer;
    }
    /* Reaction Panel */
    .reaction-panel {
      position: absolute;
      bottom: 45px;
      right: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 5px 10px;
      display: none;
      z-index: 5;
    }
    .reaction-panel span {
      cursor: pointer;
      font-size: 1.2rem;
      margin: 0 5px;
    }

    /* Chat Input pinned at the bottom */
    .chat-input-container {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background: #f0f0f0;
      border-top: 1px solid #ddd;
      flex-shrink: 0;
    }
    .chat-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 1rem;
      margin-right: 10px;
    }
    .send-button {
      background: #0088cc;
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-right: 10px;
    }
    .upload-button {
      background: #0088cc;
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    /* Display reply info above input if replying */
    .reply-info {
      background: #fff;
      border-left: 4px solid #0088cc;
      padding: 5px 10px;
      font-size: 0.9rem;
      color: #555;
      margin: 0 15px 5px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .reply-info span.reply-to-text {
      font-weight: bold;
      color: #333;
      cursor: pointer; /* can click to jump to original message */
    }

    /* Additional responsive adjustments */
    @media (max-width: 768px) {
      .chat-container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 40vh;
        left: -100%;
      }
      .sidebar.active {
        left: 0;
      }
      .chat-window {
        height: 60vh;
      }
    }
  </style>
</head>
<body>
  <!-- Main container -->
  <div class="chat-container">
    <!-- Hamburger Icon to open sidebar -->
    <div class="hamburger" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar with contacts -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">Contacts</div>
      <div class="contact-list" id="contactList">
        <!-- Built-in groups first -->
        <div class="contact-item" onclick="openGroup('FadisYouth','Fadis Youth Group')">
          <div class="contact-avatar" style="background:#0088cc;">F</div>
          <div class="contact-name">Fadis Youth Group</div>
        </div>
        <div class="contact-item" onclick="openGroup('QuranGroup','Quran Group')">
          <div class="contact-avatar" style="background:#0088cc;">Q</div>
          <div class="contact-name">Quran Group</div>
        </div>
        <div class="contact-item" onclick="openGroup('HalalJokes','Halal Jokes')">
          <div class="contact-avatar" style="background:#0088cc;">H</div>
          <div class="contact-name">Halal Jokes</div>
        </div>
        <div class="contact-item" onclick="openGroup('IslamicChat','Islamic Chat')">
          <div class="contact-avatar" style="background:#0088cc;">I</div>
          <div class="contact-name">Islamic Chat</div>
        </div>
        <!-- Firestore users appended here -->
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
      <div class="chat-header" id="chatHeader">Select a Chat</div>
      <div
        id="replyInfo"
        class="reply-info"
        style="display:none;"
      ></div>
      <div class="message-list" id="messageList"></div>
      <div
        class="chat-input-container"
        id="chatInputContainer"
        style="display:none;"
      >
        <!-- Hidden file input for uploading images/files -->
        <input
          type="file"
          id="fileInput"
          style="display:none;"
          accept="image/*,application/pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
          onchange="uploadFile(this.files)"
        />
        <!-- Upload button -->
        <button
          class="upload-button"
          onclick="document.getElementById('fileInput').click();"
        >
          <i class="fas fa-paperclip"></i>
        </button>
        <input
          type="text"
          class="chat-input"
          id="chatInput"
          placeholder="Type your message..."
        />
        <button class="send-button" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase logic -->
  <script>
    // Your Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyAFgxSMtktsqJjcJOMnkTB8yZF6T492gpA",
      authDomain: "fadis-youth.firebaseapp.com",
      databaseURL: "https://fadis-youth-default-rtdb.firebaseio.com",
      projectId: "fadis-youth",
      storageBucket: "fadis-youth.firebasestorage.app",
      messagingSenderId: "1067077305340",
      appId: "1:1067077305340:web:3ca9c71202a8020c6ba879",
      measurementId: "G-Z02SPW9ZKW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let currentChatId = null;
    let currentChatIsGroup = false;
    let messageUnsubscribe = null;
    // Holds the message being replied to (if any)
    let replyTarget = null;

    // Toggle sidebar
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
    }

    // On auth state changed
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        loadContacts();
      } else {
        currentUser = null;
        loadContacts();
      }
    });

    // Load contacts from Firestore "users" collection
    function loadContacts() {
      const contactList = document.getElementById("contactList");
      // Remove any existing user items except the built-in groups
      // (We can remove them by selecting everything after the groups)
      const builtInGroupCount = 4; // Fadis, Quran, HalalJokes, IslamicChat
      while (contactList.children.length > builtInGroupCount) {
        contactList.removeChild(contactList.lastChild);
      }

      db.collection("users")
        .orderBy("displayName")
        .get()
        .then((snapshot) => {
          snapshot.forEach((doc) => {
            const userData = doc.data();
            const displayName = userData.displayName || "Unknown";
            const onlineClass = userData.online
              ? "status-dot"
              : "status-dot inactive-dot";
            const div = document.createElement("div");
            div.className = "contact-item";
            div.onclick = () => openDirectChat(doc.id, displayName);
            div.innerHTML = `
              <div class="contact-avatar">${displayName
                .charAt(0)
                .toUpperCase()}
                <div class="${onlineClass}"></div>
              </div>
              <div class="contact-name">${displayName}</div>
            `;
            contactList.appendChild(div);
          });
        });
    }

    // Open a direct chat
    function openDirectChat(otherUserId, displayName) {
      const chatId = getChatId(otherUserId);
      currentChatId = chatId;
      currentChatIsGroup = false;
      document.getElementById("chatHeader").innerText = displayName;
      document.getElementById("chatInputContainer").style.display = "flex";
      document.getElementById("messageList").innerHTML = "";
      document.getElementById("replyInfo").style.display = "none";
      replyTarget = null;

      document.getElementById("sidebar").classList.remove("active");

      // Ensure chat doc
      if (currentUser) {
        const chatDoc = db.collection("chats").doc(chatId);
        chatDoc.get().then((docSnapshot) => {
          if (!docSnapshot.exists) {
            chatDoc.set({
              participants: [currentUser.uid, otherUserId],
              isGroup: false,
              chatName: displayName,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }
        });
      }

      subscribeToMessages(chatId);
    }

    // Return a unique ID for direct chat by sorting user IDs
    function getChatId(otherUserId) {
      if (!currentUser) return "guest_" + otherUserId;
      return [currentUser.uid, otherUserId].sort().join("_");
    }

    // Open a group chat
    function openGroup(groupId, groupName) {
      currentChatId = groupId;
      currentChatIsGroup = true;
      document.getElementById("chatHeader").innerText = groupName;
      document.getElementById("chatInputContainer").style.display = "flex";
      document.getElementById("messageList").innerHTML = "";
      document.getElementById("replyInfo").style.display = "none";
      replyTarget = null;

      // Hide sidebar
      document.getElementById("sidebar").classList.remove("active");

      if (currentUser) {
        // Ask if user wants to join this group if they are not in it
        const groupDoc = db.collection("chats").doc(groupId);
        groupDoc.get().then((docSnapshot) => {
          if (!docSnapshot.exists) {
            // Create group if doesn't exist
            groupDoc.set({
              participants: [],
              isGroup: true,
              chatName: groupName,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }
          // Check if user is in participants
          groupDoc.get().then((snap) => {
            const data = snap.data();
            if (data && data.participants && !data.participants.includes(currentUser.uid)) {
              // ask user to join
              if (confirm(`Do you want to join ${groupName}?`)) {
                groupDoc.update({
                  participants: firebase.firestore.FieldValue.arrayUnion(
                    currentUser.uid
                  ),
                });
              }
            }
          });
        });
      }
      subscribeToMessages(groupId);
    }

    // Subscribe to messages for a given chat
    function subscribeToMessages(chatId) {
      if (messageUnsubscribe) messageUnsubscribe();

      messageUnsubscribe = db
        .collection("chats")
        .doc(chatId)
        .collection("messages")
        .orderBy("timestamp")
        .onSnapshot((snapshot) => {
          const messageList = document.getElementById("messageList");
          messageList.innerHTML = "";
          snapshot.forEach((doc) => {
            const message = doc.data();
            const msgDiv = document.createElement("div");
            const sentByMe = currentUser && message.senderId === currentUser.uid;
            msgDiv.className = "message " + (sentByMe ? "sent" : "received");

            // Single or double tick
            let tickHtml = "";
            if (sentByMe) {
              tickHtml = `<span class="tick-status">${
                message.seen ? "✔✔" : "✔"
              }</span>`;
            }

            // A small reply button for every message
            const replyIcon = `
              <span class="reply-btn"
                onclick="prepareReply(event, '${doc.id}', '${escapeQuotes(
                  message.text
                )}', '${escapeQuotes(message.senderName)}')">
                <i class="fas fa-reply"></i>
              </span>
            `;

            // If message has replyTo, show a small reference
            let repliedHtml = "";
            if (message.replyTo) {
              repliedHtml = `
                <div style="font-size:0.8rem; color:#666; margin-bottom:4px; border-left:2px solid #ccc; padding-left:6px;">
                  Reply to: <span style="font-weight:bold; cursor:pointer;"
                    onclick="scrollToMessage('${message.replyTo.msgId}')">
                    ${message.replyTo.senderName}
                  </span>
                  <br>
                  <em>${message.replyTo.msgText}</em>
                </div>
              `;
            }

            // If there's an imageUrl, show it
            let imageHtml = "";
            if (message.imageUrl) {
              imageHtml = `<img src="${message.imageUrl}" class="message-image" />`;
            }

            // If there's a fileUrl (PDF, doc, etc.), show a link
            let fileLinkHtml = "";
            if (message.fileUrl && !message.imageUrl) {
              fileLinkHtml = `<div style="margin-top:5px;">
                <a href="${message.fileUrl}" target="_blank" style="color:blue; text-decoration:underline;">
                  View File
                </a>
              </div>`;
            }

            msgDiv.innerHTML = `
              <div class="sender-name">${message.senderName || "Guest"}</div>
              ${repliedHtml}
              <div class="message-text">${message.text || ""}</div>
              ${imageHtml}
              ${fileLinkHtml}
              ${tickHtml}
              ${replyIcon}
            `;
            addMessageEventListeners(msgDiv, doc.id, message);

            messageList.appendChild(msgDiv);
          });
          messageList.scrollTop = messageList.scrollHeight;
        });
    }

    // Prepare reply: store the reply target and show a small info
    function prepareReply(e, msgId, msgText, senderName) {
      e.stopPropagation();
      replyTarget = { msgId, msgText, senderName };
      const replyInfo = document.getElementById("replyInfo");
      replyInfo.innerHTML = `
        Replying to <span class="reply-to-text" onclick="scrollToMessage('${msgId}')">
          ${senderName}
        </span>:
        ${msgText}
        <span style="cursor:pointer; color:#f00; float:right;" onclick="clearReply()">✖</span>
      `;
      replyInfo.style.display = "block";
    }

    function clearReply() {
      replyTarget = null;
      document.getElementById("replyInfo").style.display = "none";
    }

    // Jump to a specific message in the chat by doc.id
    function scrollToMessage(msgId) {
      const messageList = document.getElementById("messageList");
      const allMessages = messageList.querySelectorAll(".message");
      // Not a perfect approach, but we'll try matching the stored doc.id with a data attribute
      // For a more robust approach, you might store the doc.id as an attribute on the msgDiv
      // This code is for demonstration only.
      // We'll do that here:
      // ...
      // Actually, let's store it in addMessageEventListeners:
      // But for now, we won't store it. We'll just show how you might do it.

      alert("Scroll to message " + msgId + " (implement if storing data attributes).");
    }

    // Add event listeners for reaction panel toggling on message click
    function addMessageEventListeners(msgDiv, msgId, messageData) {
      // We'll store the docId on the element so we can find it later
      msgDiv.dataset.docId = msgId;

      // Single click to show reaction panel (only for messages sent by me)
      if (currentUser && messageData.senderId === currentUser.uid) {
        msgDiv.addEventListener("click", () => {
          toggleReactionPanel(msgDiv, msgId);
        });
      }
    }

    // Toggle reaction panel
    function toggleReactionPanel(msgDiv, msgId) {
      let panel = msgDiv.querySelector(".reaction-panel");
      if (panel) {
        panel.style.display = panel.style.display === "none" ? "flex" : "none";
        return;
      }
      panel = document.createElement("div");
      panel.className = "reaction-panel";
      panel.innerHTML = `
        <span onclick="reactToMessage('${msgId}', '👍')">👍</span>
        <span onclick="reactToMessage('${msgId}', '❤️')">❤️</span>
        <span onclick="reactToMessage('${msgId}', '😂')">😂</span>
      `;
      msgDiv.appendChild(panel);
      panel.style.display = "flex";
    }

    // Example reaction
    function reactToMessage(msgId, reaction) {
      alert("Reacted with " + reaction + " to message " + msgId);
      // In a real app, you'd update the message doc with a 'reaction' field
    }

    // Send a message; if replyTarget is set, include that info
    function sendMessage() {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (text === "" && !pendingUploadUrl) return;

      let message = {
        senderId: currentUser ? currentUser.uid : "guest",
        senderName: currentUser ? currentUser.displayName || "Anonymous" : "Guest",
        text: text,
        seen: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      };

      // If replying
      if (replyTarget) {
        message.replyTo = { ...replyTarget };
      }

      // If an upload just finished, attach it
      if (pendingUploadUrl) {
        // If it's an image
        if (pendingUploadIsImage) {
          message.imageUrl = pendingUploadUrl;
        } else {
          message.fileUrl = pendingUploadUrl;
        }
      }

      db.collection("chats")
        .doc(currentChatId)
        .collection("messages")
        .add(message)
        .then(() => {
          input.value = "";
          clearReply();
          pendingUploadUrl = null;
          pendingUploadIsImage = false;
        })
        .catch((err) => {
          console.error("Error sending message:", err);
        });
    }

    // File uploading logic
    let pendingUploadUrl = null;
    let pendingUploadIsImage = false;

    function uploadFile(files) {
      if (!files || files.length === 0) return;
      const file = files[0];
      if (!file) return;

      const storageRef = storage.ref();
      const fileRef = storageRef.child("chat_uploads/" + Date.now() + "_" + file.name);
      fileRef
        .put(file)
        .then((snapshot) => snapshot.ref.getDownloadURL())
        .then((url) => {
          // Check if image
          const isImage = file.type.startsWith("image/");
          pendingUploadUrl = url;
          pendingUploadIsImage = isImage;
          // Optionally auto-send or just wait for user to press Send
          // For now, we can either auto-send or do nothing until user presses Send
          alert("File uploaded. Press Send to include it in your message.");
        })
        .catch((err) => {
          console.error("Error uploading file:", err);
        });
    }

    // Helper to escape quotes in message text
    function escapeQuotes(str) {
      if (!str) return "";
      return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
  </script>
</body>
</html>
