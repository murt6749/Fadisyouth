<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post Page</title>
  <!-- Firebase Libraries (including auth) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Basic Reset & Fonts */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f2f5; color: #1c1e21; }
    .container { max-width: 800px; margin: 2rem auto; padding: 20px; }

    /* Loading Animation */
    .loading { text-align: center; font-size: 1.2rem; margin-top: 50px; }

    /* Post Card Styles */
    .post-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
    }
    .post-header { display: flex; align-items: center; margin-bottom: 15px; }
    .author-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
    .author-info { flex-grow: 1; }
    .author-name { font-weight: 600; margin-bottom: 3px; }
    .post-time { color: #65676b; font-size: 0.9em; }
    .post-content { margin-bottom: 20px; }
    .post-actions { display: flex; gap: 15px; border-top: 1px solid #ddd; padding-top: 15px; }
    .action-btn { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; border-radius: 5px; transition: all 0.3s; }
    .action-btn:hover { background: #f0f2f5; }
    .like-btn.active { color: #1877f2; }
    .comments-section { margin-top: 20px; }
    .comment { display: flex; margin-bottom: 15px; }
    .comment-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .comment-content { background: #f0f2f5; padding: 10px; border-radius: 10px; flex-grow: 1; }
    .comment-actions { display: flex; gap: 10px; margin-top: 5px; font-size: 0.9em; }
    .reply-form { margin-left: 50px; margin-top: 10px; }
    .comment-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 20px; resize: none; }
    /* When no posts, display message */
    .no-posts { text-align: center; color: #65676b; font-size: 1.1em; margin: 40px 0; }

    /* New Post Form at Bottom */
    .new-post {
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 30px;
    }
    .new-post textarea {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
      resize: vertical;
      min-height: 100px;
      margin-bottom: 10px;
    }
    .new-post .btn-post {
      background: #1877f2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .new-post .btn-post:hover { background: #155ab6; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading animation while checking login -->
    <div id="loading" class="loading">Checking login status...</div>

    <!-- Posts will be rendered here -->
    <div id="postsSection" style="display:none;"></div>

    <!-- No posts message -->
    <div id="noPostsMessage" class="no-posts" style="display:none;">No one has posted yet. Be the first to post!</div>

    <!-- New Post Form -->
    <div class="new-post" id="newPostForm" style="display:none;">
      <h2>Create a New Post</h2>
      <textarea id="newPostText" placeholder="What's on your mind?"></textarea>
      <button class="btn-post" onclick="postNewPost()">Post</button>
    </div>
  </div>

  <script>
    // Firebase configuration â€“ replace with your own
    var firebaseConfig = {
      apiKey: "AIzaSyAFgxSMtktsqJjcJOMnkTB8yZF6T492gpA",
      authDomain: "fadis-youth.firebaseapp.com",
      databaseURL: "https://fadis-youth-default-rtdb.firebaseio.com",
      projectId: "fadis-youth",
      storageBucket: "fadis-youth.firebasestorage.app",
      messagingSenderId: "1067077305340",
      appId: "1:1067077305340:web:3ca9c71202a8020c6ba879",
      measurementId: "G-Z02SPW9ZKW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Wait for authentication state to be determined
    auth.onAuthStateChanged(function(user) {
      document.getElementById("loading").innerText = "Checking login status...";
      if (user) {
        // Logged in: hide loading and show posts section and new post form
        document.getElementById("loading").style.display = "none";
        document.getElementById("postsSection").style.display = "block";
        document.getElementById("newPostForm").style.display = "block";
        loadPosts();
      } else {
        // Not logged in: after a short delay, redirect to login.html
        setTimeout(function() {
          alert("You are not logged in. Redirecting to login page.");
          window.location.href = "login.html";
        }, 1500);
      }
    });

    // Load posts from Firestore
    function loadPosts() {
      db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const postsSection = document.getElementById("postsSection");
        postsSection.innerHTML = ""; // clear posts
        if (snapshot.empty) {
          document.getElementById("noPostsMessage").style.display = "block";
        } else {
          document.getElementById("noPostsMessage").style.display = "none";
          snapshot.forEach(doc => {
            const post = doc.data();
            postsSection.innerHTML += renderPost(doc.id, post);
          });
        }
      });
    }

    // Render a single post using the provided design
    function renderPost(id, post) {
      // Format timestamp
      let timeString = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "Just now";
      return `
      <div class="post-card" id="post-${id}">
        <div class="post-header">
          <img src="${post.authorAvatar || 'avatar.jpg'}" alt="Author Avatar" class="author-avatar">
          <div class="author-info">
            <div class="author-name">${post.authorName || "Anonymous"}</div>
            <div class="post-time">${timeString}</div>
          </div>
          <button class="btn-primary" onclick="followAuthor('${id}'); event.stopPropagation();">Follow</button>
        </div>
        <div class="post-content">
          <h2>${post.title || "Untitled Post"}</h2>
          <p>${post.content || ""}</p>
        </div>
        <div class="post-actions">
          <div class="action-btn like-btn" onclick="toggleLike(event, '${id}')">
            <i class="far fa-heart"></i>
            <span class="like-count">${post.likes || 0}</span>
          </div>
          <div class="action-btn" onclick="focusComment(event, '${id}')">
            <i class="far fa-comment"></i>
            <span class="comment-count">${post.commentsCount || 0}</span>
          </div>
          <div class="share-dropdown" onclick="toggleShare(event, '${id}')">
            <div class="action-btn">
              <i class="fas fa-share"></i> Share
            </div>
            <div class="share-options">
              <i class="fab fa-facebook social-icon"></i>
              <i class="fab fa-twitter social-icon"></i>
              <i class="fab fa-linkedin social-icon"></i>
              <i class="fas fa-link social-icon"></i>
            </div>
          </div>
        </div>
        <div class="comments-section" id="comments-${id}">
          <!-- Comments will be loaded here -->
        </div>
        <div class="comment-input-section">
          <textarea class="comment-input" placeholder="Write a comment..."></textarea>
          <button class="btn-primary" onclick="postComment(event, '${id}')">Post</button>
        </div>
      </div>`;
    }

    // Dummy functions for post actions (like, comment, follow, share)
    function toggleLike(e, postId) {
      e.stopPropagation();
      const btn = e.currentTarget;
      const countSpan = btn.querySelector('.like-count');
      let count = parseInt(countSpan.innerText);
      if(btn.classList.contains('active')) {
        btn.classList.remove('active');
        count--;
      } else {
        btn.classList.add('active');
        count++;
      }
      countSpan.innerText = count;
      // Here you could update Firestore likes count.
    }
    function focusComment(e, postId) {
      e.stopPropagation();
      const commentInput = document.querySelector(`#post-${postId} .comment-input`);
      commentInput.focus();
    }
    function toggleShare(e, postId) {
      e.stopPropagation();
      const shareOptions = e.currentTarget.querySelector('.share-options');
      shareOptions.classList.toggle('visible');
    }
    function postComment(e, postId) {
      e.stopPropagation();
      const postCard = document.getElementById("post-" + postId);
      const commentInput = postCard.querySelector('.comment-input');
      if(commentInput.value.trim() === "") return;
      // For demonstration, we simply append the comment.
      const commentsSection = postCard.querySelector('.comments-section');
      const newComment = document.createElement('div');
      newComment.className = 'comment';
      newComment.innerHTML = `
        <img src="user-avatar.jpg" alt="User Avatar" class="comment-avatar">
        <div class="comment-content">
          <div class="comment-author">You</div>
          <p>${commentInput.value}</p>
          <div class="comment-actions">
            <span>Just now</span>
            <span onclick="toggleLikeComment(this)">Like</span>
            <span onclick="toggleReplyForm(this)">Reply</span>
          </div>
          <div class="reply-form" style="display: none;">
            <textarea class="comment-input" placeholder="Write a reply..."></textarea>
            <button class="btn-primary" onclick="postReply(this)">Post</button>
          </div>
        </div>`;
      commentsSection.appendChild(newComment);
      commentInput.value = "";
      // Optionally update comment count.
    }
    function toggleLikeComment(el) {
      // Dummy toggle for comment like.
      el.classList.toggle('active');
    }
    function toggleReplyForm(el) {
      const replyForm = el.closest('.comment-content').querySelector('.reply-form');
      replyForm.style.display = replyForm.style.display === "none" ? "block" : "none";
    }
    function postReply(btn) {
      const replyInput = btn.previousElementSibling;
      if(replyInput.value.trim() === "") return;
      alert("Reply posted (stub).");
      replyInput.value = "";
      btn.closest('.reply-form').style.display = "none";
    }
    function followAuthor(postId) {
      alert("Follow functionality (stub).");
    }

    // --- New Post Functionality ---
    function postNewPost() {
      const newPostText = document.getElementById("newPostText").value.trim();
      if(newPostText === "") {
        alert("Please enter some text for your post.");
        return;
      }
      // Create a post object â€“ you can extend this with title, image, etc.
      const post = {
        authorName: auth.currentUser ? auth.currentUser.displayName || "User" : "User",
        authorAvatar: auth.currentUser ? auth.currentUser.photoURL || "avatar.jpg" : "avatar.jpg",
        content: newPostText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: 0,
        commentsCount: 0,
        questionText: newPostText  // For compatibility with existing design
      };
      db.collection("posts").add(post).then(() => {
        document.getElementById("newPostText").value = "";
      }).catch(error => {
        console.error("Error posting new post:", error);
      });
    }

    // --- Firebase Auth Check ---
    firebase.auth().onAuthStateChanged(function(user) {
      if(!user) {
        // If not logged in, show an alert and redirect after a short delay.
        setTimeout(() => {
          alert("You are not logged in. Redirecting to login page.");
          window.location.href = "login.html";
        }, 1500);
      }
    });

    // --- Navigation Modal Functions ---
    function openNavModal(sheikhName) {
      document.getElementById("navModal").classList.add("active");
    }
    function closeNavModal() {
      document.getElementById("navModal").classList.remove("active");
    }

    // Add sparkle animation to each card
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.card').forEach(card => {
        let sparkleContainer = document.createElement('div');
        sparkleContainer.className = 'sparkles';
        card.appendChild(sparkleContainer);
        for(let i = 0; i < 15; i++){
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = Math.random() * 100 + '%';
          sparkle.style.top = Math.random() * 100 + '%';
          sparkle.style.animationDelay = Math.random() * 1.5 + 's';
          sparkleContainer.appendChild(sparkle);
        }
      });
    });
  </script>
  <!-- Firebase Auth is needed for checking login -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</body>
</html>
