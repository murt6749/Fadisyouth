<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post Page</title>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Basic Reset & Typography */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f2f5; color: #1c1e21; }
    
    /* Top Navigation */
    .top-nav {
      display: flex;
      justify-content: flex-end;
      padding: 10px 20px;
      background: linear-gradient(45deg, #7f7fd5, #86a8e7);
    }
    .account-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #ff6f61;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 20px;
    }
    .loading {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 50px;
    }
    
    /* Post Card Styles */
    .post-card {
      background: linear-gradient(135deg, #ffffff, #fffefc);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
      transition: transform 0.3s ease;
    }
    .post-card:hover { transform: translateY(-3px); }
    
    .post-header { display: flex; align-items: center; margin-bottom: 15px; }
    .author-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #1877f2;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
    }
    .author-info { flex-grow: 1; }
    .author-name { font-weight: 600; }
    .post-time { color: #65676b; font-size: 0.85em; }
    
    .post-content { margin-bottom: 20px; }
    .post-content h2 { margin-bottom: 10px; color: #2c3e50; }
    .post-content p { line-height: 1.6; }
    
    .post-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
      align-items: center;
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .action-btn:hover { color: #1877f2; }
    .like-btn.active { color: #1877f2; }
    
    /* New Post Form */
    .new-post {
      background: linear-gradient(135deg, #86a8e7, #7f7fd5);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 20px;
      margin-top: 30px;
      color: white;
    }
    .new-post h2 { margin-bottom: 15px; }
    .new-post input[type="text"],
    .new-post textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
    }
    .new-post input[type="text"] { font-weight: 600; }
    .new-post textarea { resize: vertical; min-height: 100px; }
    .new-post .btn-post {
      background: #ff6f61;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    .new-post .btn-post:hover { background: #e65b50; }
    
    /* No Posts Message */
    .no-posts {
      text-align: center;
      font-size: 1.1rem;
      color: #65676b;
      margin: 40px 0;
    }
  </style>
</head>
<body>
  <!-- Top Navigation with default account icon -->
  <div class="top-nav">
    <div class="account-icon" onclick="window.location.href='post_account.html'">
      <!-- This will display the first letter of the logged-in user's display name (or default "A") -->
      A
    </div>
  </div>
  
  <div class="container">
    <div id="loading" class="loading">Checking login status...</div>
    <div id="postsSection" style="display:none;"></div>
    <div id="noPostsMessage" class="no-posts" style="display:none;">No one has posted yet. Be the first to post!</div>
    
    <!-- New Post Form -->
    <div class="new-post" id="newPostForm" style="display:none;">
      <h2>Create a New Post</h2>
      <input type="text" id="postTopic" placeholder="Topic">
      <textarea id="postBody" placeholder="What's on your mind?"></textarea>
      <button class="btn-post" onclick="postNewPost()">Post</button>
    </div>
  </div>
  
  <script>
    // Initialize Firebase (replace with your actual config)
    var firebaseConfig = {
      apiKey: "AIzaSyAFgxSMtktsqJjcJOMnkTB8yZF6T492gpA",
      authDomain: "fadis-youth.firebaseapp.com",
      databaseURL: "https://fadis-youth-default-rtdb.firebaseio.com",
      projectId: "fadis-youth",
      storageBucket: "fadis-youth.firebasestorage.app",
      messagingSenderId: "1067077305340",
      appId: "1:1067077305340:web:3ca9c71202a8020c6ba879",
      measurementId: "G-Z02SPW9ZKW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Check login state and show posts or redirect to login.html
    auth.onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("postsSection").style.display = "block";
        document.getElementById("newPostForm").style.display = "block";
        // Update account icon letter
        const displayName = user.displayName || "A";
        document.querySelector(".account-icon").innerText = displayName.charAt(0).toUpperCase();
        loadPosts();
      } else {
        setTimeout(() => {
          alert("You are not logged in. Redirecting to login page.");
          window.location.href = "login.html";
        }, 1500);
      }
    });

    // Load posts from "posts" collection ordered by timestamp descending
    function loadPosts() {
      db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const postsSection = document.getElementById("postsSection");
        postsSection.innerHTML = "";
        if (snapshot.empty) {
          document.getElementById("noPostsMessage").style.display = "block";
        } else {
          document.getElementById("noPostsMessage").style.display = "none";
          snapshot.forEach(doc => {
            const post = doc.data();
            postsSection.innerHTML += renderPost(doc.id, post);
          });
        }
      });
    }

    // Render a single post
    function renderPost(id, post) {
      // Format timestamp
      let timeString = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "Just now";
      // Determine author's avatar: if authorAvatar exists, use it; otherwise, show a colorful circle with first letter.
      let authorDisplay = "";
      if(post.authorAvatar) {
        authorDisplay = `<img src="${post.authorAvatar}" alt="Avatar" class="author-avatar">`;
      } else {
        const name = post.authorName || "A";
        authorDisplay = `<div class="author-avatar" style="background: #${Math.floor(Math.random()*16777215).toString(16)};">${name.charAt(0).toUpperCase()}</div>`;
      }
      // Follow button: if current user is not the author, display a Follow button; if already following, show "Following"
      let followButton = "";
      if(auth.currentUser && auth.currentUser.uid !== post.authorUID) {
        followButton = `<button class="btn-post" id="follow-${id}" onclick="toggleFollow(event, '${post.authorUID}', '${id}')">Follow</button>`;
      }
      return `
      <div class="post-card" id="post-${id}">
        <div class="post-header">
          ${authorDisplay}
          <div class="author-info">
            <div class="author-name">${post.authorName || "Anonymous"}</div>
            <div class="post-time">${timeString}</div>
          </div>
          ${followButton}
        </div>
        <div class="post-content">
          <h2>${post.topic || "Untitled"}</h2>
          <p>${post.body || ""}</p>
        </div>
        <div class="post-actions">
          <div class="action-btn like-btn" onclick="toggleLike(event, '${id}')">
            <i class="far fa-heart"></i>
            <span class="like-count">${post.likesCount || 0}</span>
          </div>
          <div class="action-btn" onclick="focusComment(event, '${id}')">
            <i class="far fa-comment"></i> Comment
          </div>
          <div class="action-btn" onclick="toggleShare(event)">
            <i class="fas fa-share"></i> Share
          </div>
        </div>
        <!-- Comments Section (hidden by default) -->
        <div class="comments-section" id="comments-${id}" style="display:none;"></div>
      </div>`;
    }

    // Like functionality – update Firestore document with likes array
    function toggleLike(e, postId) {
      e.stopPropagation();
      const user = auth.currentUser;
      if (!user) {
        alert("Please log in to like posts.");
        return;
      }
      const postRef = db.collection("posts").doc(postId);
      postRef.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          let likes = data.likes || [];
          if (likes.includes(user.uid)) {
            // Already liked, so remove
            likes = likes.filter(uid => uid !== user.uid);
          } else {
            likes.push(user.uid);
          }
          postRef.update({ likes: likes, likesCount: likes.length });
        }
      });
    }

    // Follow functionality: Use a "follows" collection where each document id is "currentUserUID_authorUID"
    function toggleFollow(e, authorUID, postId) {
      e.stopPropagation();
      const user = auth.currentUser;
      if (!user) {
        alert("Please log in to follow users.");
        return;
      }
      const followDocId = user.uid + "_" + authorUID;
      const followRef = db.collection("follows").doc(followDocId);
      followRef.get().then(doc => {
        if (doc.exists) {
          // Already following – unfollow
          followRef.delete().then(() => {
            document.getElementById("follow-" + postId).innerText = "Follow";
          });
        } else {
          // Follow the author
          followRef.set({ follower: user.uid, following: authorUID, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
          .then(() => {
            document.getElementById("follow-" + postId).innerText = "Following";
          });
        }
      });
    }

    // Dummy functions for comment and share – you can extend these as needed
    function focusComment(e, postId) {
      e.stopPropagation();
      // For simplicity, toggling visibility of a comment section could be implemented
      const commentsSection = document.getElementById("comments-" + postId);
      commentsSection.style.display = commentsSection.style.display === "none" ? "block" : "none";
    }
    function toggleShare(e) {
      e.stopPropagation();
      alert("Share functionality (stub).");
    }

    // New Post Functionality – user can create a post with a topic and body
    function postNewPost() {
      const topic = document.getElementById("postTopic").value.trim();
      const body = document.getElementById("postBody").value.trim();
      if (topic === "" || body === "") {
        alert("Please fill in both a topic and body.");
        return;
      }
      const user = auth.currentUser;
      const post = {
        authorName: user.displayName || "Anonymous",
        authorUID: user.uid,
        // For avatar, you might use user.photoURL; if not, leave it null and render a circle with first letter.
        authorAvatar: user.photoURL || null,
        topic: topic,
        body: body,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: [],
        likesCount: 0
      };
      db.collection("posts").add(post).then(() => {
        document.getElementById("postTopic").value = "";
        document.getElementById("postBody").value = "";
      }).catch(error => {
        console.error("Error posting:", error);
      });
    }

    // Firebase Auth Check: If not logged in, redirect to login.html after animation.
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        setTimeout(() => {
          alert("You are not logged in. Redirecting to login page.");
          window.location.href = "login.html";
        }, 1500);
      }
    });

    // Navigation Modal – only opens when the avatar-container is clicked.
    function openNavModal(sheikhName) {
      document.getElementById("navModal").classList.add("active");
    }
    function closeNavModal() {
      document.getElementById("navModal").classList.remove("active");
    }

    // Add sparkle animation to each card
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.card').forEach(card => {
        let sparkleContainer = document.createElement('div');
        sparkleContainer.className = 'sparkles';
        card.appendChild(sparkleContainer);
        for (let i = 0; i < 15; i++) {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = Math.random() * 100 + '%';
          sparkle.style.top = Math.random() * 100 + '%';
          sparkle.style.animationDelay = Math.random() * 1.5 + 's';
          sparkleContainer.appendChild(sparkle);
        }
      });
    });
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
</body>
</html>
