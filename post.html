<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post Page</title>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Reset & Typography */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #1c1e21; }
    
    /* Top Navigation */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: linear-gradient(45deg, #7f7fd5, #86a8e7);
    }
    .account-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #ff6f61;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    .search-container {
      position: relative;
    }
    .search-icon {
      font-size: 1.5rem;
      color: white;
      cursor: pointer;
    }
    .search-box {
      position: absolute;
      top: 40px;
      right: 0;
      width: 250px;
      padding: 8px;
      border: none;
      border-radius: 20px;
      outline: none;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .search-results {
      position: absolute;
      top: 70px;
      right: 0;
      width: 250px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 100;
    }
    .search-result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: #f0f2f5; }
    
    /* Main Container */
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 20px;
    }
    .loading {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 50px;
    }
    
    /* Post Card Styles */
    .post-card {
      background: linear-gradient(135deg, #ffffff, #fffefc);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      margin-bottom: 20px;
      padding: 20px;
      transition: transform 0.3s ease;
    }
    .post-card:hover { transform: translateY(-3px); }
    
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .author-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #1877f2;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      overflow: hidden;
    }
    .author-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .author-info { flex-grow: 1; }
    .author-name { font-weight: 600; }
    .post-time { color: #65676b; font-size: 0.85em; }
    
    .post-content { margin-bottom: 20px; }
    .post-content h2 { margin-bottom: 10px; color: #2c3e50; }
    .post-content p { line-height: 1.6; }
    
    .post-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
      align-items: center;
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .action-btn:hover { color: #1877f2; }
    .like-btn.active { color: #1877f2; }
    
    /* Comments Section */
    .comments-section {
      display: none;
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .comment {
      display: flex;
      margin-bottom: 10px;
    }
    .comment-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #1877f2;
      color: white;
      font-weight: bold;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    .comment-content {
      background: #f0f2f5;
      padding: 10px;
      border-radius: 10px;
      flex-grow: 1;
    }
    .comment-input-section {
      margin-top: 10px;
      display: none;
    }
    .comment-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      resize: none;
    }
    
    /* New Post Form */
    .new-post {
      background: linear-gradient(135deg, #86a8e7, #7f7fd5);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 20px;
      margin-top: 30px;
      color: white;
    }
    .new-post h2 { margin-bottom: 15px; }
    .new-post input[type="text"],
    .new-post textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
    }
    .new-post input[type="text"] { font-weight: 600; }
    .new-post textarea { resize: vertical; min-height: 100px; }
    .new-post .btn-post {
      background: #ff6f61;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    .new-post .btn-post:hover { background: #e65b50; }
    
    /* No Posts Message */
    .no-posts {
      text-align: center;
      font-size: 1.1rem;
      color: #65676b;
      margin: 40px 0;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <div class="top-nav">
    <div class="account-icon" onclick="window.location.href='post_account.html'">A</div>
    <div class="search-container">
      <i class="fas fa-search search-icon" onclick="toggleSearch()"></i>
      <input type="text" class="search-box" id="searchBox" placeholder="Search users...">
      <div class="search-results" id="searchResults"></div>
    </div>
  </div>
  
  <div class="container">
    <div id="loading" class="loading">Checking login status...</div>
    <div id="postsSection" style="display:none;"></div>
    <div id="noPostsMessage" class="no-posts" style="display:none;">No one has posted yet. Be the first to post!</div>
    
    <!-- New Post Form -->
    <div class="new-post" id="newPostForm" style="display:none;">
      <h2>Create a New Post</h2>
      <input type="text" id="postTopic" placeholder="Topic">
      <textarea id="postBody" placeholder="What's on your mind?"></textarea>
      <button class="btn-post" onclick="postNewPost()">Post</button>
    </div>
  </div>
  
  <!-- Navigation Modal (only opens when avatar is clicked) -->
  <div class="nav-modal" id="navModal" onclick="closeNavModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeNavModal()">X</button>
      <h2>Fadis Youth Portal</h2>
      <p>Welcome to Fadis Youth – a vibrant community for learning and growth. Explore our resources below.</p>
      <div class="nav-buttons">
        <a href="https://murt6749.github.io/Fadisyouth/index.html" target="_blank">Home</a>
        <a href="https://murt6749.github.io/Fadisyouth/quran.html" target="_blank">Quraana</a>
        <a href="https://murt6749.github.io/Fadisyouth/fatwa.html" target="_blank">Fatwaa</a>
      </div>
      <button class="btn-post" style="margin-top:20px;" onclick="closeNavModal()">Close</button>
    </div>
  </div>
  
  <script>
    // Initialize Firebase – replace with your own configuration
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Search Functionality ---
    function toggleSearch() {
      const searchBox = document.getElementById("searchBox");
      const resultsDiv = document.getElementById("searchResults");
      if(searchBox.style.display === "block") {
        searchBox.style.display = "none";
        resultsDiv.style.display = "none";
      } else {
        searchBox.style.display = "block";
        searchBox.focus();
      }
    }
    document.getElementById("searchBox").addEventListener("input", function() {
      const query = this.value.trim();
      const resultsDiv = document.getElementById("searchResults");
      if(query === "") {
        resultsDiv.innerHTML = "";
        resultsDiv.style.display = "none";
        return;
      }
      // Search in "users" collection by displayName (ensure it's indexed)
      db.collection("users").where("displayName", ">=", query)
        .where("displayName", "<=", query + "\uf8ff")
        .limit(10)
        .get().then(snapshot => {
          let html = "";
          snapshot.forEach(doc => {
            const user = doc.data();
            html += `<div class="search-result-item" onclick="goToUserProfile('${doc.id}')">${user.displayName}</div>`;
          });
          resultsDiv.innerHTML = html;
          resultsDiv.style.display = "block";
        });
    });
    function goToUserProfile(userId) {
      window.location.href = "profile.html?uid=" + userId;
    }
    
    // --- Auth Check ---
    auth.onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("postsSection").style.display = "block";
        document.getElementById("newPostForm").style.display = "block";
        const displayName = user.displayName || "A";
        document.querySelector(".account-icon").innerText = displayName.charAt(0).toUpperCase();
        loadPosts();
      } else {
        alert("You are not logged in. Redirecting to login page.");
        window.location.href = "login.html";
      }
    });
    
    // --- Load Posts ---
    function loadPosts() {
      db.collection("posts").orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          const postsSection = document.getElementById("postsSection");
          postsSection.innerHTML = "";
          if (snapshot.empty) {
            document.getElementById("noPostsMessage").style.display = "block";
          } else {
            document.getElementById("noPostsMessage").style.display = "none";
            snapshot.forEach(doc => {
              const post = doc.data();
              postsSection.innerHTML += renderPost(doc.id, post);
            });
          }
        });
    }
    
    // --- Render a Post Card ---
    function renderPost(id, post) {
      let timeString = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "Just now";
      let avatarHTML = "";
      if (post.authorAvatar) {
        avatarHTML = `<img src="${post.authorAvatar}" alt="Avatar" class="author-avatar">`;
      } else {
        const name = post.authorName || "A";
        const hue = Math.floor(Math.random() * 360);
        avatarHTML = `<div class="author-avatar" style="background: hsl(${hue}, 70%, 80%); color: #1c1e21;">${name.charAt(0).toUpperCase()}</div>`;
      }
      let followBtn = "";
      if (auth.currentUser && auth.currentUser.uid !== post.authorUID) {
        followBtn = `<button class="btn-post" id="follow-${id}" onclick="toggleFollow(event, '${post.authorUID}', '${id}')">+</button>`;
      }
      return `
      <div class="post-card" id="post-${id}">
        <div class="post-header">
          ${avatarHTML}
          <div class="author-info">
            <div class="author-name">${post.authorName || "Anonymous"}</div>
            <div class="post-time">${timeString}</div>
          </div>
          ${followBtn}
        </div>
        <div class="post-content">
          <h2>${post.topic || "Untitled"}</h2>
          <p>${post.body || ""}</p>
        </div>
        <div class="post-actions">
          <div class="action-btn like-btn" onclick="toggleLike(event, '${id}')">
            <i class="far fa-heart"></i>
            <span class="like-count">${post.likesCount || 0}</span>
          </div>
          <div class="action-btn" onclick="toggleComments(event, '${id}')">
            <i class="far fa-comment"></i> Comment
          </div>
          <div class="action-btn" onclick="sharePost(event, '${id}')">
            <i class="fas fa-share"></i> Share
          </div>
        </div>
        <div class="comments-section" id="comments-${id}"></div>
      </div>`;
    }
    
    // --- Like Functionality ---
    function toggleLike(e, postId) {
      e.stopPropagation();
      const user = auth.currentUser;
      if (!user) { alert("Please log in to like posts."); return; }
      const postRef = db.collection("posts").doc(postId);
      postRef.get().then(doc => {
        if (doc.exists) {
          let data = doc.data();
          let likes = data.likes || [];
          if (likes.includes(user.uid)) {
            likes = likes.filter(uid => uid !== user.uid);
          } else {
            likes.push(user.uid);
          }
          postRef.update({ likes: likes, likesCount: likes.length });
        }
      });
    }
    
    // --- Follow Functionality ---
    function toggleFollow(e, authorUID, postId) {
      e.stopPropagation();
      const user = auth.currentUser;
      if (!user) { alert("Please log in to follow users."); return; }
      const followDocId = user.uid + "_" + authorUID;
      const followRef = db.collection("follows").doc(followDocId);
      followRef.get().then(doc => {
        if (doc.exists) {
          followRef.delete().then(() => {
            document.getElementById("follow-" + postId).innerText = "+";
          });
        } else {
          followRef.set({
            follower: user.uid,
            following: authorUID,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            document.getElementById("follow-" + postId).innerText = "Following";
          });
        }
      });
    }
    
    // --- Comments Functionality ---
    function toggleComments(e, postId) {
      e.stopPropagation();
      const commentsSection = document.getElementById("comments-" + postId);
      if (commentsSection.style.display === "block") {
        commentsSection.style.display = "none";
      } else {
        commentsSection.style.display = "block";
        loadComments(postId);
      }
    }
    function loadComments(postId) {
      const commentsSection = document.getElementById("comments-" + postId);
      db.collection("posts").doc(postId).collection("comments")
        .orderBy("timestamp", "asc")
        .onSnapshot(snapshot => {
          let html = "";
          snapshot.forEach(doc => {
            const comment = doc.data();
            let commentTime = comment.timestamp ? new Date(comment.timestamp.toDate()).toLocaleTimeString() : "Just now";
            html += `<div class="comment">
                      <div class="comment-avatar">${(comment.authorName || "U").charAt(0).toUpperCase()}</div>
                      <div class="comment-content">
                        <div class="comment-author">${comment.authorName || "Anonymous"}</div>
                        <p>${comment.text}</p>
                        <div class="comment-actions">
                          <span>${commentTime}</span>
                          <span onclick="toggleLikeComment(this)">Like</span>
                          <span onclick="toggleReplyForm(this)">Reply</span>
                        </div>
                        <div class="reply-form" style="display:none;">
                          <textarea class="comment-input" placeholder="Write a reply..."></textarea>
                          <button class="btn-post" onclick="postReply(event, '${postId}', this)">Post</button>
                        </div>
                      </div>
                    </div>`;
          });
          commentsSection.innerHTML = html;
        });
    }
    function toggleLikeComment(el) { el.classList.toggle("active"); }
    function toggleReplyForm(el) {
      const replyForm = el.closest(".comment-content").querySelector(".reply-form");
      replyForm.style.display = (replyForm.style.display === "none" || replyForm.style.display === "") ? "block" : "none";
    }
    function postReply(e, postId, btn) {
      e.stopPropagation();
      const replyForm = btn.closest(".reply-form");
      const replyInput = replyForm.querySelector("textarea");
      if(replyInput.value.trim() === "") return;
      const user = auth.currentUser;
      const reply = {
        authorName: user.displayName || "User",
        text: replyInput.value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection("posts").doc(postId).collection("comments").add(reply)
        .then(() => { replyInput.value = ""; replyForm.style.display = "none"; });
    }
    
    // --- Share Functionality ---
    function sharePost(e, postId) {
      e.stopPropagation();
      const postURL = window.location.href + "#post-" + postId;
      if (navigator.share) {
        navigator.share({
          title: "Check out this post",
          url: postURL
        }).catch(err => console.error("Error sharing:", err));
      } else {
        navigator.clipboard.writeText(postURL).then(() => {
          alert("Post URL copied to clipboard.");
        });
      }
    }
    
    // --- New Post Functionality ---
    function postNewPost() {
      const topic = document.getElementById("postTopic").value.trim();
      const body = document.getElementById("postBody").value.trim();
      if (topic === "" || body === "") {
        alert("Please fill in both a topic and body.");
        return;
      }
      const user = auth.currentUser;
      const post = {
        authorName: user.displayName || "Anonymous",
        authorUID: user.uid,
        authorAvatar: user.photoURL || null,
        topic: topic,
        body: body,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: [],
        likesCount: 0
      };
      db.collection("posts").add(post)
        .then(() => {
          document.getElementById("postTopic").value = "";
          document.getElementById("postBody").value = "";
        })
        .catch(error => { console.error("Error posting new post:", error); });
    }
    
    // --- Firebase Auth Check ---
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("postsSection").style.display = "block";
        document.getElementById("newPostForm").style.display = "block";
        const displayName = user.displayName || "A";
        document.querySelector(".account-icon").innerText = displayName.charAt(0).toUpperCase();
        loadPosts();
      } else {
        alert("You are not logged in. Redirecting to login page.");
        window.location.href = "login.html";
      }
    });
    
    // --- Navigation Modal (opens only when avatar is clicked) ---
    function openNavModal(sheikhName) {
      document.getElementById("navModal").classList.add("active");
    }
    function closeNavModal() {
      document.getElementById("navModal").classList.remove("active");
    }
    
    // --- Sparkle Animation ---
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.card').forEach(card => {
        let sparkleContainer = document.createElement('div');
        sparkleContainer.className = 'sparkles';
        card.appendChild(sparkleContainer);
        for(let i = 0; i < 15; i++){
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = Math.random() * 100 + '%';
          sparkle.style.top = Math.random() * 100 + '%';
          sparkle.style.animationDelay = Math.random() * 1.5 + 's';
          sparkleContainer.appendChild(sparkle);
        }
      });
    });
  </script>
  <!-- Ensure firebase-auth loads last -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</body>
</html>
