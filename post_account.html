<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post Management</title>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1877f2;
      --danger-color: #dc3545;
      --success-color: #28a745;
      --background-color: #f8f9fa;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: var(--background-color);
    }
    /* Mobile First Layout */
    .management-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .mobile-menu-btn {
      display: block;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      font-size: 1.2rem;
    }
    .sidebar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background: white;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 999;
    }
    .sidebar.active {
      display: block;
    }
    .main-content {
      padding: 1rem;
      margin-top: 60px;
    }
    /* Post Card Styles */
    .post-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    /* Responsive Tables */
    @media (max-width: 768px) {
      .post-meta {
        flex-direction: column;
      }
      .search-bar {
        width: 100% !important;
      }
    }
    /* Tablet and Desktop Styles */
    @media (min-width: 768px) {
      .management-container {
        flex-direction: row;
      }
      .mobile-menu-btn {
        display: none;
      }
      .sidebar {
        display: block;
        position: relative;
        height: auto;
        box-shadow: none;
      }
      .main-content {
        flex: 1;
        padding: 2rem;
        margin-top: 0;
      }
      .post-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }
    }
    /* Common Styles */
    .sidebar-menu {
      list-style: none;
      margin-top: 2rem;
    }
    .sidebar-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .sidebar-item.active {
      background: var(--primary-color);
      color: white;
    }
    .management-header {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .search-bar {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      width: 100%;
    }
    .post-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .filter-btn {
      padding: 8px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      background: white;
    }
    .filter-btn.active {
      background: var(--primary-color);
      color: white;
    }
    .post-status {
      font-size: 0.8em;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: inline-block;
    }
    .published { background: var(--success-color); color: white; }
    .draft { background: #6c757d; color: white; }
    .scheduled { background: #ffc107; color: black; }
    .post-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    .action-btn {
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #ddd;
      background: white;
      transition: all 0.3s;
    }
    .action-btn:hover {
      background: var(--primary-color);
      color: white;
    }
    .post-controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .btn-control {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
      color: white;
    }
    .btn-control.edit { background: var(--primary-color); }
    .btn-control.delete { background: var(--danger-color); }
    .btn-control.restore { background: var(--success-color); }
    .btn-control:hover { opacity: 0.9; }
    .post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    /* Section Headings */
    .section-heading {
      margin: 20px 0;
      font-size: 1.3rem;
      color: #2B5A46;
      text-align: center;
    }
    /* Navigation Modal (for Top Navigation) */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      width: 95%;
      max-width: 500px;
    }
    .close-btn {
      float: right;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 1rem;
    }
    /* Checking animation */
    .loading {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 50px;
      position: relative;
    }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0,0,0,0.3);
      border-radius: 50%;
      border-top-color: #1877f2;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
  
  <div class="management-container">
    <nav class="sidebar">
      <h2>Dashboard</h2>
      <ul class="sidebar-menu">
        <li class="sidebar-item active">Posts</li>
        <li class="sidebar-item">Analytics</li>
        <li class="sidebar-item">Scheduled</li>
        <li class="sidebar-item">Drafts</li>
        <li class="sidebar-item">Settings</li>
      </ul>
    </nav>

    <main class="main-content">
      <div class="management-header">
        <h1>Post Management</h1>
        <input type="text" class="search-bar" placeholder="Search posts...">
      </div>

      <div class="post-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="published">Published</button>
        <button class="filter-btn" data-filter="draft">Drafts</button>
        <button class="filter-btn" data-filter="scheduled">Scheduled</button>
      </div>

      <!-- Post Grid: we will load the user's posts here -->
      <div class="post-grid" id="postGrid"></div>
    </main>
  </div>

  <!-- Edit Post Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="display:inline;">Edit Post</h3>
        <span class="close-btn" onclick="closeModal()">&times;</span>
      </div>
      <form id="editForm">
        <label>Title</label>
        <input type="text" id="editTitle" class="search-bar" placeholder="Post title">
        <label>Content</label>
        <textarea id="editContent" class="search-bar" rows="4" placeholder="Post content"></textarea>
        <label>Status</label>
        <select id="editStatus">
          <option value="published">Published</option>
          <option value="draft">Draft</option>
          <option value="scheduled">Scheduled</option>
        </select>
        <div id="editScheduleContainer" style="display:none; margin-top:10px;">
          <label>Scheduled At</label>
          <input type="datetime-local" id="editScheduledAt">
        </div>
        <div class="post-actions" style="margin-top: 1rem;">
          <button type="button" class="action-btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="action-btn" style="background: var(--primary-color); color: white;">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Modal -->
  <div class="modal" id="statsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="display:inline;">Post Analytics</h3>
        <span class="close-btn" onclick="closeModal()">&times;</span>
      </div>
      <div class="post-meta">
        <div><strong>1,234</strong> Views</div>
        <div><strong>256</strong> Likes</div>
        <div><strong>89</strong> Comments</div>
      </div>
    </div>
  </div>

  <!-- Fadis Youth Portal Modal -->
  <div class="modal" id="navModalTop">
    <div class="modal-content">
      <span class="close-btn" onclick="closeNavModalTop()">&times;</span>
      <h3>Fadis Youth Portal</h3>
      <p>Welcome to Fadis Youth – a vibrant community for learning and growth.</p>
      <div class="nav-buttons">
        <a href="https://murt6749.github.io/Fadisyouth/index.html" target="_blank">Home</a>
        <a href="https://murt6749.github.io/Fadisyouth/quran.html" target="_blank">Quraana</a>
        <a href="https://murt6749.github.io/Fadisyouth/fatwa.html" target="_blank">Fatwaa</a>
      </div>
      <button class="btn-post" style="margin-top:20px;" onclick="closeNavModalTop()">Close</button>
    </div>
  </div>

  <!-- Checking login status with spinner -->
  <div class="loading" id="loading">Checking login status...<span class="spinner"></span></div>

  <script>
    /* ========== Basic UI from your design ========== */
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('active');
    }
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    function closeModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
    }
    function openNavModalTop() {
      document.getElementById("navModalTop").style.display = 'flex';
    }
    function closeNavModalTop() {
      document.getElementById("navModalTop").style.display = 'none';
    }

    // Filter button logic
    let currentFilter = "all";
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute("data-filter");
        loadPosts();
      });
    });

    // Searching posts by title
    document.querySelector('.search-bar').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll('.post-card').forEach(card => {
        const titleEl = card.querySelector('h2');
        const title = titleEl ? titleEl.textContent.toLowerCase() : "";
        card.style.display = title.includes(term) ? 'block' : 'none';
      });
    });

    // Close modal if user clicks outside it
    window.onclick = function(e) {
      if (e.target.classList.contains('modal')) closeModal();
    };

    /* ========== Firebase Integration ========== */
    var firebaseConfig = {
      apiKey: "AIzaSyAFgxSMtktsqJjcJOMnkTB8yZF6T492gpA",
      authDomain: "fadis-youth.firebaseapp.com",
      databaseURL: "https://fadis-youth-default-rtdb.firebaseio.com",
      projectId: "fadis-youth",
      storageBucket: "fadis-youth.firebasestorage.app",
      messagingSenderId: "1067077305340",
      appId: "1:1067077305340:web:3ca9c71202a8020c6ba879",
      measurementId: "G-Z02SPW9ZKW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentEditPostId = null;

    // Wait for Firebase Auth
    auth.onAuthStateChanged(function(user) {
      document.getElementById("loading").style.display = "none"; // hide checking spinner
      if (user) {
        currentUser = user;
        // Optionally, show user's initial in some top nav icon
        // e.g. document.querySelector('.account-icon').innerText = user.displayName ? user.displayName[0] : "A";
        loadPosts();
      } else {
        if (confirm("You are not logged in. Do you want to log in?")) {
          window.location.href = "login.html";
        }
      }
    });

    // Load posts from Firestore for the current user
    function loadPosts() {
      if (!currentUser) {
        document.getElementById("postGrid").innerHTML = "<p style='text-align:center;'>Please log in to manage your posts.</p>";
        return;
      }
      let query = db.collection("posts")
                    .where("authorUID", "==", currentUser.uid)
                    .where("trashed", "==", false);
      if (currentFilter !== "all") {
        query = query.where("status", "==", currentFilter);
      }
      query.orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const postGrid = document.getElementById("postGrid");
        if (snapshot.empty) {
          postGrid.innerHTML = "<p style='text-align:center;'>No posts found.</p>";
          return;
        }
        let html = "";
        snapshot.forEach(doc => {
          const post = doc.data();
          html += renderPost(doc.id, post);
        });
        postGrid.innerHTML = html;
      });
    }

    // Render a single post card
    function renderPost(id, post) {
      let timeString = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "Just now";
      let statusClass = post.status || "draft"; // e.g. published, draft, scheduled
      let statusLabel = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
      // build status pill
      let statusPill = `<span class="post-status ${statusClass}">${statusLabel}</span>`;

      return `
      <div class="post-card" id="post-${id}">
        ${statusPill}
        <h2>${post.topic || "Untitled"}</h2>
        <div class="post-meta">
          <span>Last updated: ${timeString}</span>
          <span>Views: ${post.viewsCount || 0}</span>
        </div>
        <div class="post-actions">
          <button class="action-btn" onclick="openEditModal('${id}')">Edit</button>
          <button class="action-btn" onclick="openModal('statsModal')">Stats</button>
          <button class="action-btn" onclick="moreOptions('${id}')">⋮</button>
        </div>
      </div>`;
    }

    // Example function for "⋮" button
    function moreOptions(postId) {
      alert("More options for post " + postId);
    }

    // Edit Modal
    document.getElementById("editForm").addEventListener("submit", e => {
      e.preventDefault();
      saveEdit();
    });
    function openEditModal(postId) {
      currentEditPostId = postId;
      db.collection("posts").doc(postId).get().then(doc => {
        if (doc.exists) {
          const post = doc.data();
          document.getElementById("editTitle").value = post.topic || "";
          document.getElementById("editContent").value = post.body || "";
          document.getElementById("editStatus").value = post.status || "published";
          if (post.status === "scheduled" && post.scheduledAt) {
            document.getElementById("editScheduleContainer").style.display = "block";
            document.getElementById("editScheduledAt").value = new Date(post.scheduledAt.toDate()).toISOString().slice(0,16);
          } else {
            document.getElementById("editScheduleContainer").style.display = "none";
            document.getElementById("editScheduledAt").value = "";
          }
          openModal("editModal");
        }
      });
    }
    document.getElementById("editStatus").addEventListener("change", e => {
      if (e.target.value === "scheduled") {
        document.getElementById("editScheduleContainer").style.display = "block";
      } else {
        document.getElementById("editScheduleContainer").style.display = "none";
        document.getElementById("editScheduledAt").value = "";
      }
    });
    function saveEdit() {
      if (!currentEditPostId) return;
      let newTitle = document.getElementById("editTitle").value.trim();
      let newContent = document.getElementById("editContent").value.trim();
      let newStatus = document.getElementById("editStatus").value;
      let updateData = {
        topic: newTitle,
        body: newContent,
        status: newStatus,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      if (newStatus === "scheduled") {
        let scheduledVal = document.getElementById("editScheduledAt").value;
        if (!scheduledVal) {
          alert("Please select a scheduled date/time.");
          return;
        }
        updateData.scheduledAt = firebase.firestore.Timestamp.fromDate(new Date(scheduledVal));
      } else {
        updateData.scheduledAt = null;
      }
      if (!newTitle || !newContent) {
        alert("Title and content cannot be empty.");
        return;
      }
      db.collection("posts").doc(currentEditPostId).update(updateData)
        .then(() => {
          alert("Post updated.");
          closeModal();
        })
        .catch(err => console.error("Error updating post:", err));
    }
  </script>
</body>
</html>
