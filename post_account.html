<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Stats</title>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Base Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #1c1e21; }

    /* Header */
    .header {
      background: linear-gradient(45deg, #7f7fd5, #86a8e7);
      padding: 20px;
      text-align: center;
      color: white;
    }
    .header h1 { font-size: 2rem; }

    /* Stats Container */
    .stats-container {
      max-width: 900px;
      margin: 20px auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 0 20px;
    }
    .stat-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 20px;
      cursor: pointer;
      transition: transform 0.2s ease;
      position: relative;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card h2 { font-size: 1.2rem; margin-bottom: 10px; }
    .stat-card .stat-value { font-size: 2rem; font-weight: bold; }
    .stat-details {
      display: none;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
      margin-top: 15px;
      padding-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    /* For listing names/comments */
    .detail-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }
    .detail-item:last-child { border-bottom: none; }
    /* Last Activity */
    .last-activity { font-size: 1rem; color: #555; }
    /* Loading Spinner */
    .loading { text-align: center; font-size: 1.2rem; margin-top: 50px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>My Stats</h1>
  </div>

  <div id="loading" class="loading">Loading your statistics...</div>
  <div id="statsContainer" class="stats-container" style="display:none;">
    <!-- Stat Cards will be injected here -->
    <div class="stat-card" id="totalPostsCard">
      <h2>Total Posts</h2>
      <div class="stat-value" id="totalPostsValue">0</div>
    </div>
    <div class="stat-card" id="totalLikesCard">
      <h2>Total Likes Received</h2>
      <div class="stat-value" id="totalLikesValue">0</div>
      <div class="stat-details" id="likesDetails"></div>
    </div>
    <div class="stat-card" id="totalCommentsCard">
      <h2>Total Comments</h2>
      <div class="stat-value" id="totalCommentsValue">0</div>
      <div class="stat-details" id="commentsDetails"></div>
    </div>
    <div class="stat-card" id="lastActivityCard">
      <h2>Last Activity</h2>
      <div class="last-activity" id="lastActivityValue">N/A</div>
    </div>
  </div>

  <script>
    // Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyAFgxSMtktsqJjcJOMnkTB8yZF6T492gpA",
      authDomain: "fadis-youth.firebaseapp.com",
      databaseURL: "https://fadis-youth-default-rtdb.firebaseio.com",
      projectId: "fadis-youth",
      storageBucket: "fadis-youth.firebasestorage.app",
      messagingSenderId: "1067077305340",
      appId: "1:1067077305340:web:3ca9c71202a8020c6ba879",
      measurementId: "G-Z02SPW9ZKW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    // When auth state changes, load the stats
    auth.onAuthStateChanged(function(user) {
      if (user) {
        currentUser = user;
        loadStats();
      } else {
        alert("Please log in to view your stats.");
        window.location.href = "login.html";
      }
    });

    // Function to load stats
    async function loadStats() {
      const postsSnapshot = await db.collection("posts")
        .where("authorUID", "==", currentUser.uid)
        .get();

      let totalPosts = postsSnapshot.size;
      let totalLikes = 0;
      let totalComments = 0;
      let lastActivityTimestamp = 0;
      let likeUserIDs = new Set();
      let allComments = [];

      // Process each post document
      const postPromises = postsSnapshot.docs.map(async (doc) => {
        let data = doc.data();
        totalLikes += data.likesCount || 0;
        // Gather the likes (an array of user IDs) if available
        if (data.likes && Array.isArray(data.likes)) {
          data.likes.forEach(uid => likeUserIDs.add(uid));
        }
        // Check for last activity (timestamp)
        if (data.timestamp && data.timestamp.toMillis() > lastActivityTimestamp) {
          lastActivityTimestamp = data.timestamp.toMillis();
        }
        // Get comments count for each post by querying its subcollection "comments"
        const commentsSnapshot = await db.collection("posts").doc(doc.id).collection("comments").get();
        totalComments += commentsSnapshot.size;
        // Also accumulate comment details (for drop down) 
        commentsSnapshot.forEach(commentDoc => {
          let commentData = commentDoc.data();
          // Attach post topic to indicate which post the comment belongs to
          commentData.postTopic = data.topic || "Untitled";
          allComments.push(commentData);
        });
      });
      await Promise.all(postPromises);

      // Update the card values
      document.getElementById("totalPostsValue").innerText = totalPosts;
      document.getElementById("totalLikesValue").innerText = totalLikes;
      document.getElementById("totalCommentsValue").innerText = totalComments;
      document.getElementById("lastActivityValue").innerText = lastActivityTimestamp 
        ? new Date(lastActivityTimestamp).toLocaleString() 
        : "No activity yet";

      // Set up toggling for the Like and Comment cards
      setupToggle("totalLikesCard", "likesDetails", async function() {
        // When the like card is clicked, list the names of the users who liked his posts.
        // Convert set to array and fetch user display names from "users" collection.
        let idsArray = Array.from(likeUserIDs);
        if (idsArray.length === 0) return "<div class='detail-item'>No likes yet</div>";
        let detailsHTML = "";
        const userPromises = idsArray.map(async uid => {
          const userDoc = await db.collection("users").doc(uid).get();
          let displayName = userDoc.exists ? userDoc.data().displayName : "Unknown";
          return `<div class="detail-item">${displayName}</div>`;
        });
        const userItems = await Promise.all(userPromises);
        detailsHTML = userItems.join("");
        return detailsHTML;
      });
      setupToggle("totalCommentsCard", "commentsDetails", async function() {
        // When the comment card is clicked, list all comments (with post topic and comment text)
        if (allComments.length === 0) return "<div class='detail-item'>No comments yet</div>";
        let detailsHTML = allComments.map(c => {
          return `<div class="detail-item"><strong>${c.postTopic}:</strong> ${c.text} <em>by ${c.authorName || "Anonymous"}</em></div>`;
        }).join("");
        return detailsHTML;
      });

      // Hide loading and show stats container
      document.getElementById("loading").style.display = "none";
      document.getElementById("statsContainer").style.display = "grid";
    }

    // Helper to set up toggle behavior for a card
    function setupToggle(cardId, detailsId, loadDetailsFunc) {
      const card = document.getElementById(cardId);
      const details = document.getElementById(detailsId);
      let detailsLoaded = false;
      card.addEventListener("click", async function(e) {
        // Prevent event from bubbling if click is on already toggled details
        if (e.target.closest(".stat-details")) return;
        if (details.style.display === "block") {
          details.style.display = "none";
        } else {
          // If not loaded yet, call the async function to fill details
          if (!detailsLoaded) {
            details.innerHTML = "<div class='loading'>Loading...</div>";
            details.innerHTML = await loadDetailsFunc();
            detailsLoaded = true;
          }
          details.style.display = "block";
        }
      });
    }
  </script>
</body>
</html>
